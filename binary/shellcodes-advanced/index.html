<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Security Summer School</title><meta name=description content="Table of contents Introduction Tutorials 01. Tutorial: preventing stack operations from overwriting the shellcode 02. Tutorial: NOP sleds 03. Tutorial: null-free shellcodes 04. Tutorial: shellcodes in pwntools 05. Tutorial: alphanumeric shellcode Challenges 06. Challenge: NOP sled redo 07. Challenge: No NOPs allowed! 08. Challenge: multiline output 09: Challenge: execve blocking attempt Further Reading Input restrictions Introduction In the previous session, we learned about shellcodes, a form of code injection which allowed us to hijack the control flow of a process and make it do our bidding."><meta property="og:title" content><meta property="og:description" content="Table of contents Introduction Tutorials 01. Tutorial: preventing stack operations from overwriting the shellcode 02. Tutorial: NOP sleds 03. Tutorial: null-free shellcodes 04. Tutorial: shellcodes in pwntools 05. Tutorial: alphanumeric shellcode Challenges 06. Challenge: NOP sled redo 07. Challenge: No NOPs allowed! 08. Challenge: multiline output 09: Challenge: execve blocking attempt Further Reading Input restrictions Introduction In the previous session, we learned about shellcodes, a form of code injection which allowed us to hijack the control flow of a process and make it do our bidding."><meta property="og:type" content="article"><meta property="og:url" content="/binary/shellcodes-advanced/"><meta property="article:section" content="binary"><meta property="og:site_name" content="Security Summer School"><meta itemprop=name content><meta itemprop=description content="Table of contents Introduction Tutorials 01. Tutorial: preventing stack operations from overwriting the shellcode 02. Tutorial: NOP sleds 03. Tutorial: null-free shellcodes 04. Tutorial: shellcodes in pwntools 05. Tutorial: alphanumeric shellcode Challenges 06. Challenge: NOP sled redo 07. Challenge: No NOPs allowed! 08. Challenge: multiline output 09: Challenge: execve blocking attempt Further Reading Input restrictions Introduction In the previous session, we learned about shellcodes, a form of code injection which allowed us to hijack the control flow of a process and make it do our bidding."><meta itemprop=wordCount content="3149"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Table of contents Introduction Tutorials 01. Tutorial: preventing stack operations from overwriting the shellcode 02. Tutorial: NOP sleds 03. Tutorial: null-free shellcodes 04. Tutorial: shellcodes in pwntools 05. Tutorial: alphanumeric shellcode Challenges 06. Challenge: NOP sled redo 07. Challenge: No NOPs allowed! 08. Challenge: multiline output 09: Challenge: execve blocking attempt Further Reading Input restrictions Introduction In the previous session, we learned about shellcodes, a form of code injection which allowed us to hijack the control flow of a process and make it do our bidding."><link rel=preload href=/scss/main.min.5aef8a3f4159801f5dbe642e33f5332212e837eda91d37dcd891fdcd5c32498a.css as=style><link href=/scss/main.min.5aef8a3f4159801f5dbe642e33f5332212e837eda91d37dcd891fdcd5c32498a.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=font-weight-bold>Security Summer School</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/binary/><span class=active>Binary Exploitation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/essentials/><span>Security Essentials</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/><span>Web Security</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-binary-li><a href=/binary/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-binary><span>Binary Exploitation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybuffer-exploitation-li><a href=/binary/buffer-exploitation/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybuffer-exploitation><span>Buffer Exploitation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarydefense-mechanisms-li><a href=/binary/defense-mechanisms/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarydefense-mechanisms><span>Defense Mechanisms</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarydynamic-analysis-li><a href=/binary/dynamic-analysis/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarydynamic-analysis><span>Dynamic Analysis</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryexecutables-and-processes-li><a href=/binary/executables-and-processes/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryexecutables-and-processes><span>Executables and Processes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryexploration-tools-li><a href=/binary/exploration-tools/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryexploration-tools><span>Exploration Tools</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryinformation-leaks-li><a href=/binary/information-leaks/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryinformation-leaks><span>Information Leaks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryreturn-oriented-programming-li><a href=/binary/return-oriented-programming/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryreturn-oriented-programming><span>Return Oriented Programming</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryreturn-oriented-programming-advanced-li><a href=/binary/return-oriented-programming-advanced/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryreturn-oriented-programming-advanced><span>Return Oriented Programming Advanced</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryshellcodes-li><a href=/binary/shellcodes/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryshellcodes><span>Shellcodes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-binaryshellcodes-advanced-li><a href=/binary/shellcodes-advanced/ title class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-binaryshellcodes-advanced><span class=td-sidebar-nav-active-item>Shellcodes Advanced</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarystatic-analysis-li><a href=/binary/static-analysis/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarystatic-analysis><span>Static Analysis</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities03-tutorial-bypass-dep-no-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/03-tutorial-bypass-dep-no-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities03-tutorial-bypass-dep-no-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities08-challenge-bypass-dep-no-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/08-challenge-bypass-dep-no-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities08-challenge-bypass-dep-no-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities09-challenge-bypass-dep-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/09-challenge-bypass-dep-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities09-challenge-bypass-dep-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarycopying-li><a href=/binary/copying/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarycopying><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryextrapwntools-introreadme-li><a href=/binary/extra/pwntools-intro/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryextrapwntools-introreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryreviewing-li><a href=/binary/reviewing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryreviewing><span></span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/security-summer-school/security-summer-school.github.io/tree/main/content/en/binary/shellcodes-advanced/index.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> View page source</a>
<a href=https://github.com/security-summer-school/security-summer-school.github.io/edit/main/content/en/binary/shellcodes-advanced/index.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/security-summer-school/security-summer-school.github.io/new/main/content/en/binary/shellcodes-advanced/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/security-summer-school/security-summer-school.github.io/issues/new?title=" class=td-page-meta--issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/security-summer-school/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
<a id=print href=/binary/_print/><i class="fa fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#01-tutorial-preventing-stack-operations-from-overwriting-the-shellcode>01. Tutorial: preventing stack operations from overwriting the shellcode</a></li><li><a href=#02-tutorial-nop-sleds>02. Tutorial: NOP sleds</a></li><li><a href=#03-tutorial-null-free-shellcodes>03. Tutorial: null-free shellcodes</a></li><li><a href=#04-tutorial-shellcodes-in-pwntools>04. Tutorial: shellcodes in pwntools</a></li><li><a href=#05-tutorial-alphanumeric-shellcode>05. Tutorial: alphanumeric shellcode</a></li></ul><ul><li><a href=#06-challenge-nop-sled-redo>06. Challenge: NOP sled redo</a></li><li><a href=#07-challenge-no-nops-allowed>07. Challenge: No NOPs allowed!</a></li><li><a href=#08-challenge-multiline-output>08. Challenge: multiline output</a></li><li><a href=#09-challenge-execve-blocking-attempt>09: Challenge: <code>execve</code> blocking attempt</a></li></ul><ul><li><a href=#input-restrictions>Input restrictions</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/binary/>Binary Exploitation</a></li><li class="breadcrumb-item active" aria-current=page><a href=/binary/shellcodes-advanced/ aria-disabled=true class="btn-link disabled">Shellcodes Advanced</a></li></ol></nav><div class=td-content><h1></h1><header class=article-meta></header><details open><summary>Table of contents</summary><ul><li><a href=#introduction>Introduction</a></li><li><a href=#tutorials>Tutorials</a><ul><li><a href=#01-tutorial-preventing-stack-operations-from-overwriting-the-shellcode>01. Tutorial: preventing stack operations from overwriting the shellcode</a></li><li><a href=#02-tutorial-nop-sleds>02. Tutorial: NOP sleds</a></li><li><a href=#03-tutorial-null-free-shellcodes>03. Tutorial: null-free shellcodes</a></li><li><a href=#04-tutorial-shellcodes-in-pwntools>04. Tutorial: shellcodes in pwntools</a></li><li><a href=#05-tutorial-alphanumeric-shellcode>05. Tutorial: alphanumeric shellcode</a></li></ul></li><li><a href=#challenges>Challenges</a><ul><li><a href=#06-challenge-nop-sled-redo>06. Challenge: NOP sled redo</a></li><li><a href=#07-challenge-no-nops-allowed>07. Challenge: No NOPs allowed!</a></li><li><a href=#08-challenge-multiline-output>08. Challenge: multiline output</a></li><li><a href=#09-challenge-execve-blocking-attempt>09: Challenge: execve blocking attempt</a></li></ul></li><li><a href=#further-reading>Further Reading</a><ul><li><a href=#input-restrictions>Input restrictions</a></li></ul></li></ul></details><h1 id=introduction>Introduction</h1><p>In <a href=../shellcodes>the previous session</a>, we learned about <strong>shellcodes</strong>, a form of <strong>code injection</strong> which allowed us to hijack the control flow of a process and make it do our bidding. The three steps for a succesful shellcode attack are:</p><ul><li><strong>develop</strong>: obtain the machine code for the desired functionality</li><li><strong>inject</strong>: place the shellcode into the process&rsquo; address space</li><li><strong>trigger</strong>: divert control flow to the beginning of our shellcode</li></ul><p>The first step seems pretty straightforward, but there are a lot of things that could go wrong with the last two. For example, we cannot inject a shellcode in a process that doesn&rsquo;t read input or reads very little (though remember that if we can launch the target program we can place the shellcode inside its environment or command line arguments); we cannot trigger our shellcode if we cannot overwrite some code-pointer (e.g. a saved return) or if we do not know the precise address at which it ends up in the process&rsquo; memory and we cannot use such an attack if there isn&rsquo;t some memory region where we have both write and execute permissions.</p><p>Some of these hurdles can occur naturally, while others are intentionally created as preventive measures (e.g. on modern platforms, any memory area can be either writable or executable, but not both, a concept known as <a href=https://en.wikipedia.org/wiki/W%5EX>W^X</a>). Anyway, it is useful to think about these problems and how to work around them, then put that knowledge into practice.</p><h1 id=tutorials>Tutorials</h1><h2 id=01-tutorial-preventing-stack-operations-from-overwriting-the-shellcode>01. Tutorial: preventing stack operations from overwriting the shellcode</h2><p>When performing a shellcode attack we often needed to write some stuff in memory so that it has a valid address. For example, to perform an <code>execve("/bin/sh", ["/bin/sh", NULL], NULL)</code> syscall, we need to place the string <code>"/bin/sh"</code> in memory and fill the <code>rdi</code> register (first argument of a syscall) with that address. In theory we could write it in any writable area but, as you might have noticed in the previous session, it&rsquo;s usually simpler to just use the stack.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>    <span style=color:#000>mov</span> <span style=color:#000>rax</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>`/</span><span style=color:#000>bin</span><span style=color:#a40000>/</span><span style=color:#000>sh</span><span style=color:#a40000>`</span>
</span></span><span style=display:flex><span>    <span style=color:#000>push</span> <span style=color:#000>rax</span>
</span></span></code></pre></div><p>results in fewer machine-code bytes than:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>    <span style=color:#000>mov</span> <span style=color:#000>rax</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>`/</span><span style=color:#000>bin</span><span style=color:#a40000>/</span><span style=color:#000>sh</span><span style=color:#a40000>`</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mov</span> <span style=color:#000>rbx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0x00404000</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mov</span> <span style=color:#000>qword</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>rbx</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>rax</span>
</span></span></code></pre></div><p>plus, <code>push</code>-ing has the side effect of placing our address in the <code>rsp</code> register which we could later <code>mov</code> somewhere else, avoiding the need of explicitly referring to some address (which might be difficult to predict, or even random, in the case of ASLR).</p><p>In cases where our shellcode is also injected on the stack this leads to the complicated situation in which the stack serves as both a code and data region. If we aren&rsquo;t careful, our data pushes might end up overwriting the injected code and ruining our attack.</p><p>Run <code>make</code> then use the <code>exploit.py</code> script (don&rsquo;t bother with how it works, for now); it will create a shellcode, pad it and feed it to the program, then open a new terminal window with a <code>gdb</code> instance breaked at the end of the <code>main</code> function. You can then explore what happens step by step and you will notice that, as the shellcode pushes the data it needs onto the stack it eventually comes to overwrite itself, resulting in some garbage.</p><p>The problem is that, after executing <code>ret</code> at the end of <code>main</code> and getting hijacked to jump to the beginning of our shellcode, <code>rip</code> ends up at <code>0x7ffca44f2280</code>, while <code>rsp</code> ends up at <code>0x7ffca44f22c0</code> (addresses on your machine will probably differ). The instruction pointer is only 64 bytes <strong>below</strong> the stack pointer.</p><ul><li>as instructions get executed, the instruction pointer is <em>incremented</em></li><li>as values are pushed onto the stack, the stack pointer is <em>decremented</em></li></ul><p>Thus the difference will shrink more and more with each instruction executed. The total length of the shellcode is 48 bytes so that means that after pushing 16 bytes onto the stack (64 - 48) any <code>push</code> will overwrite the end of our shellcode!</p><p>One obvious solution is to try and modify our shellcode to make it shorter, or to make it push less data onto the stack; this might work in some situations, but it&rsquo;s not a general fix.</p><p>Remember that after the vulnerable function returns, we control the execution of the program; so we can control what happens to the stack! Then we&rsquo;ll simply move the top of the stack to give us some space by adding this as the first instruction to our shellcode:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>  <span style=color:#000>sub</span> <span style=color:#000>rsp</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>64</span>
</span></span></code></pre></div><p>Now, right after jumping to our shellcode, <code>rip</code> and <code>rsp</code> will be the same, but they&rsquo;ll go on in opposite directions and everything will be well. Uncomment line 64 in <code>exploit.py</code>, run it again and see what happens.</p><p>If we&rsquo;re at the very low-edge of the stack and can&rsquo;t access memory below, we can use <code>add</code> to move the stack pointer way up, so that even if the pushed data comes towards our injected code, it will not reach it; after all, our shellcode is short and we&rsquo;re not pushing much.</p><h2 id=02-tutorial-nop-sleds>02. Tutorial: NOP sleds</h2><p>In the previous session, you probably had some difficulties with the <a href=../shellcodes#09-challenge-shellcode-after-saved-ret---no-leak>ninth task</a>, which asked you to perform a shellcode-on-stack attack without having a leak of the overflown buffer&rsquo;s address. You can determine it using <code>gdb</code> but, as you&rsquo;ve seen, things differ between <code>gdb</code> and non-<code>gdb</code> environments; the problem is even worse if the target binary is running on a remote machine.</p><p>The crux of the issue is the fact that we have to precisely guess <strong>one</strong> exact address where our shellcode begins. For example, our shellcode might end up looking like this in memory:</p><pre tabindex=0><code>   0x7fffffffce28:  rex.WX adc QWORD PTR [rax+0x0],rax
   0x7fffffffce2c:  add    BYTE PTR [rax],al
   0x7fffffffce2e:  add    BYTE PTR [rax],al
=&gt; 0x7fffffffce30:  push   0x68
   0x7fffffffce32:  movabs rax,0x732f2f2f6e69622f
   0x7fffffffce3c:  push   rax
   0x7fffffffce3d:  mov    rdi,rsp
   0x7fffffffce40:  push   0x1016972
</code></pre><p>The first instruction of our shellcode is the <code>push 0x68</code> at address <code>0x7fffffffce30</code>:</p><ul><li>if we jump before it, we&rsquo;ll execute some garbage interpreted as code; in the above example, missing it by two bytes would execute <code>add BYTE PTR [rax],al</code> which might SEGFAULT if <code>rax</code> doesn&rsquo;t happen to hold a valid writable address</li><li>if we jump after it, we&rsquo;ll have a malformed <code>"/bin/sh"</code> string on the stack, so the later <code>execve</code> call will not work.</li></ul><p>Fortunately, we don&rsquo;t have to consider the entire address space, so our chances are better than 1 in 2<sup>64</sup>:</p><ul><li>the stack is usually placed at a fixed address (e.g. 0x7fffffffdd000), so we have a known-prefix several octets wide</li><li>due to alignment concerns, the compiler emits code that places buffers and other local data at nice, rounded addresses (ending in <code>0</code>, or <code>c0</code>, <code>00</code> etc.), so we have a known-suffix several bits wide</li></ul><p>On your local machine, using <code>gdb</code> to look at the buffer&rsquo;s address will then allow you to use just a bit of bruteforce search to determine the address outside of <code>gdb</code>.</p><p>But what if we could increase our chances to jump to the beginning of our shellcode? So that we don&rsquo;t have to guess <strong>one</strong> exact address, but just hit some address range? This is where &ldquo;NOP sleds&rdquo; come in.</p><p>A &ldquo;NOP sled&rdquo; is simply a string of <code>NOP</code> instructions added as a prefix to a shellcode. The salient features of a <code>NOP</code> instruction that make it useful for us are:</p><ul><li>it does nothing</li><li>it&rsquo;s one byte long</li></ul><p>Thus if we chain a bunch of these together and prepend them to our shellcode, we can jump inside the middle of the &ldquo;NOP sled&rdquo; at any position and it will be alright: each subsequent <code>NOP</code> instruction will be executed, doing nothing, then our shellcode will be reached.</p><p>Our shellcode will end up looking like this in the process memory:</p><pre tabindex=0><code>   0x7fffffffd427:  mov BYTE PTR [rax], al
   0x7fffffffd429:  nop
   0x7fffffffd42a:  nop
   0x7fffffffd42b:  nop
   0x7fffffffd42c:  nop
   0x7fffffffd42d:  nop
   0x7fffffffd42e:  nop
   0x7fffffffd42f:  nop
=&gt; 0x7fffffffd430:  push   0x68
   0x7fffffffd432:  movabs rax,0x732f2f2f6e69622f
   0x7fffffffd43c:  push   rax
</code></pre><p>Again, our first &ldquo;useful&rdquo; instruction is the <code>push 0x68</code> at <code>0x7fffffffd430</code>. Jumping after it and skipping its execution is still problematic, but notice that we can now jump <strong>before</strong> it, missing it by several bytes with no issue. If we jump to <code>0x7fffffffd42c</code> for example, we&rsquo;ll reach a <code>nop</code>, then execution will pass on to the next <code>nop</code> and so on; after executing 4 nops, our shellcode will be reached and everything will be as if we had jumped directly to <code>0x7fffffffd430</code> in the first place. There is now a continuous range of 8 addresses where it&rsquo;s ok to jump to.</p><p>But 8 is such a small number; the longer the NOP sled, the better our chances. The only limit is how much data we can feed into the program when we inject our shellcode.</p><ul><li>Run <code>make</code>, then inspect the <code>vuln</code> binary in <code>gdb</code> and determine the location of the vulnerable buffer.</li><li>Modify line 14 of the <code>exploit.py</code> script with the address you&rsquo;ve found, then run the script. Most likely, it will not work: the address outside of <code>gdb</code> is different.</li><li>Uncomment line 17 of the script, then run it again.</li><li>You should now have a shell!</li></ul><p>If this doesn&rsquo;t work, play a bit with the address left on line 14; increment it by 256, then decrement it by 256. You&rsquo;re aiming to get <strong>below</strong> the actual address at some offset smaller than the NOP sled length which, in this example, is 1536.</p><h2 id=03-tutorial-null-free-shellcodes>03. Tutorial: null-free shellcodes</h2><p>Up until now, all the vulnerable programs attacked used <code>read</code> as a method of getting the input. This allows us to feed them any string of arbitrary bytes. In practice, however, there are many cases in which the input is treated as a 0-terminated <em>string</em> and processed by functions like <code>strcpy</code>.</p><p>This means that our shellcode cannot contain a 0 byte because, as far as functions like <code>strcpy</code> are concerned, that signals the end of the input. However, shellcodes are likely to contain 0 bytes. For example, remember that we need to set <code>rax</code> to a value indicating the syscall we want; if we wish to <code>execve</code> a new shell, we&rsquo;ll have to place the value <code>59</code> in <code>rax</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>  <span style=color:#000>mov</span> <span style=color:#000>rax</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0x3b</span>
</span></span></code></pre></div><p>Due to the nature of x86 instructions and the size of the <code>rax</code> register, that <code>0x3b</code> might be considered an 8-byte wide constant, yielding the following machine code: <code>48 b8 59 00 00 00 00 00 00 00</code>.</p><p>As you can see, there are quite a lot of zeroes. We could get rid of them if we considered <code>0x3b</code> to be a 1-byte wide constant; unfortunately there&rsquo;s no instruction to place into <code>rax</code> an immediate 1-byte value. However, there is an instruction to place an immediate 1-byte value in <code>al</code>, the lowest octet of <code>rax</code>. But we need the other seven octets to be 0&mldr; Fortunately, we can do a trick by xor-ing the register with itself! This will make every bit 0, plus the <code>xor</code> instruction itself doesn&rsquo;t contain 0 bytes. So we can replace the code above with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>  <span style=color:#000>xor</span> <span style=color:#000>rax</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>rax</span>
</span></span><span style=display:flex><span>  <span style=color:#000>mov</span> <span style=color:#000>al</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0x3b</span>
</span></span></code></pre></div><p>Which assembles to <code>48 31 c0 b0 3b</code>. Not only are there no 0 bytes, we&rsquo;ve also reduced the size of the code!</p><p>Takeaways:</p><ul><li>xor-ing a register with itself is a good way of obtaining some zeroes in memory without using zeroes in machine code</li><li>working with the lower parts of registers avoids immediate values with leading-zeroes</li></ul><p>We can apply these insights in other situations to avoid zeroes in our code. For example, instead of</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>    <span style=color:#000>mov</span> <span style=color:#000>rax</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>`/</span><span style=color:#000>bin</span><span style=color:#a40000>/</span><span style=color:#000>sh</span><span style=color:#a40000>\</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#a40000>`</span>
</span></span><span style=display:flex><span>    <span style=color:#000>push</span> <span style=color:#000>rax</span>
</span></span></code></pre></div><p>We can write:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>    <span style=color:#000>xor</span> <span style=color:#000>rax</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>rax</span>
</span></span><span style=display:flex><span>    <span style=color:#000>push</span> <span style=color:#000>rax</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mov</span> <span style=color:#000>rax</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>`//</span><span style=color:#000>bin</span><span style=color:#a40000>/</span><span style=color:#000>sh</span><span style=color:#a40000>`</span>
</span></span><span style=display:flex><span>    <span style=color:#000>push</span> <span style=color:#000>rax</span>
</span></span></code></pre></div><p>Note that extra-slashes in a path don&rsquo;t make any difference.</p><p>The <code>vuln.c</code> program reads data properly into a buffer, then uses <code>strcpy</code> to move data into a smaller buffer, resulting in an overflow. Run <code>make</code>, then the <code>exploit.py</code> script; just like before, it will start a new terminal window with a <code>gdb</code> instance in which you can explore what happens. The attack will fail because the injected shellcode contains 0 bytes so <code>strcpy</code> will only stop copying well before the end of the shellcode.</p><p>Comment line 55 and uncomment line 56, replacing the shellcode with a null-free version. Run <code>exploit.py</code> again. It should work!</p><h2 id=04-tutorial-shellcodes-in-pwntools>04. Tutorial: shellcodes in pwntools</h2><p>Once again, <code>pwntools</code> can come to our aid and help us with shellcode attacks. The most useful feature for this is the <a href=https://docs.pwntools.com/en/stable/shellcraft.html>shellcraft module</a> which offers prebuilt shellcodes for various architectures.</p><p>For example, to obtain a shellcode which performs <code>execve("/bin/sh", {"/bin/sh", NULL}, NULL)</code> on an <code>x86_64</code> platform we can call:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>shellcraft</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>amd64</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>linux</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sh</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><p>Note that this will give you back text representing <em>assembly code</em> and <strong>not</strong> <em>machine code</em> bytes. You can then use the <code>asm</code> function to assemble it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>asm</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>shellcraft</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>amd64</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>linux</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sh</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>arch</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amd64&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;linux&#34;</span><span style=color:#000;font-weight:700>))</span>
</span></span></code></pre></div><p>Remember the friendly features of pwntools! Instead of always specifying the OS and the architecture, we can set them in the global context, like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>arch</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amd64&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;linux&#34;</span>
</span></span></code></pre></div><p>Or - even simpler - we can indicate a particular binary and let pwntools deduce the OS and architecture: <code>context.binary = "./vuln"</code>. We can then invoke a much cleaner <code>asm(shellcraft.sh())</code>.</p><p>Besides the magic snippet to invoke a shell, there are other builtin code fragments, such as to cause a crash, an infinite loop, <code>cat</code> a file or call some other syscall. Play around with <code>shellcraft</code>, inspecting the output. You&rsquo;ll notice that all these shellcodes are free of zero bytes and newlines!</p><h2 id=05-tutorial-alphanumeric-shellcode>05. Tutorial: alphanumeric shellcode</h2><p>It is commonly the case that user input is filtered to make sure it matches certain conditions. Most user input expected from a keyboard should not contain non-printable characters; a &ldquo;name&rdquo; should contain only letters, a PIN should contain only digits, etc.</p><p>The program might check its input against some conditions and, if rejected, bail in such a way so as to not trigger our injected code. This places the burden on us to develop shellcode that doesn&rsquo;t contain certain bytes. We&rsquo;ve seen how we can avoid newlines and zero bytes to work around some input-reading functions. This concept can be pushed even further, heavily restricting our character set: on 32-bit platforms, we can write <strong>alphanumeric shellcodes</strong>!</p><p>But can we really? It&rsquo;s plausible that there are some clever tricks on the level of replacing <code>mov eax, 0x3b</code> with <code>xor eax, eax; mov al, 0x3b</code> that could make use of only alphanumeric characters, but all our shellcodes so far need to perform a syscall. Looking at the encoding of the <code>int 0x80</code> instruction seems pretty grim: <code>\xcd\x80</code>. Those are not even printable characters. So how can we perform a syscall?</p><p>Here it&rsquo;s important to step back and carefully consider our assumptions:</p><ul><li>There is some memory region to which we have both write and execute access (otherwise we wouldn&rsquo;t attempt a code injection attack)</li><li>After our input is read, there is some check on it to make sure it doesn&rsquo;t contain certain characters.</li></ul><p>Aha! We cannot <strong>inject</strong> some bytes, but nothing&rsquo;s stopping us from injecting something that <strong>generates</strong> those bytes! Generating is just an alternative way of <em>writing</em>, so instead of <strong>injecting</strong> our shellcode, we&rsquo;ll inject some code which <strong>generates</strong> the shellcode, then executes it!</p><p>This is, in fact, as complicated as it sounds, so we won&rsquo;t do it ourselves. We&rsquo;ll just observe how such a shellcode, produced by a specialized tool (<code>msfvenom</code>) works. So invoke the following command, which should give you a python-syntax buffer containing an alphanumeric shellcode that executes &ldquo;/bin/sh&rdquo;:</p><p><code>msfvenom -a x86 --platform linux -p linux/x86/exec -e x86/alpha_mixed BufferRegister=ECX -f python</code></p><ul><li><code>-a x86</code>: specifies the architecture as 32-bit x86</li><li><code>--platform linux</code>: specifies OS</li><li><code>-p linux/x86/exec</code>: specifies a preset program (you can use <code>-</code> or <code>STDIN</code> for a custom initial shellcode, to be transformed)</li><li><code>-e x86/alpha_mixed</code>: specifies encoding to be alphanumeric</li><li><code>BufferRegister=ECX</code>: specifies an initial register which holds the address of the buffer; this is needed in order to have some way to refer to the region in which we&rsquo;re unpacking our code. Without this, a short non-alphanumeric preamble is added instead to automatically extract the buffer address</li><li><code>-f python</code>: formats output using python syntax</li></ul><p><code>msfvenom</code> is actually capable of taking an arbitrary assembly snippet and transforming it into an alphanumeric &ldquo;bootstrapper&rdquo; which, once injected, unpacks the original shellcode and executes it.</p><h1 id=challenges>Challenges</h1><h2 id=06-challenge-nop-sled-redo>06. Challenge: NOP sled redo</h2><p>Redo the last three challenges (9, 10, 11) from <a href=../shellcodes>the previous session</a> using NOP-sleds.</p><h2 id=07-challenge-no-nops-allowed>07. Challenge: No NOPs allowed!</h2><p>This is similar to the previous tasks: you are left to guess a stack address. However, the <code>\x90</code> byte is filtered from input so you cannot use a NOP sled. But you should be able to adapt the concept. Remember the relevant features of the &ldquo;NOP&rdquo; instruction!</p><h2 id=08-challenge-multiline-output>08. Challenge: multiline output</h2><p>While perfectly ok with the byte 0, some functions (e.g. <code>fgets</code>) will stop reading when they encounter a newline character (<code>\n</code>). Thus, if our input is read by such a function, we need to make sure our shellcode contains no <code>\n</code> bytes.</p><p>For this challenge, the input will be read using the <code>gets</code> function, but you will need to craft a shellcode which prints to <code>stdout</code> the exact string:</p><pre tabindex=0><code>first
second
third
</code></pre><h2 id=09-challenge-execve-blocking-attempt>09: Challenge: <code>execve</code> blocking attempt</h2><p>If shellcodes are such a powerful threat, what if we attempted to block some shellcode-sepcific characters? Such as the bytes that encode a <code>syscall</code> function. Or the slash needed in a path; maybe it&rsquo;s not such a big loss to avoid these in legitimate inputs.</p><p>Can you still get a shell? For this task, <strong>don&rsquo;t use</strong> an existing encoder, but rather apply the encoding principles yourself.</p><h1 id=further-reading>Further Reading</h1><p><a href=http://phrack.org/issues/49/14.html>&ldquo;Smashing The Stack For Fun And Profit&rdquo;, Aleph One</a> - a legendary attack paper documenting SBOs and shellcodes. As it is written in &lsquo;96, the examples in it will probably <em>not</em> work (either out-of-the-box or with some tweaks). We recommend perusing it for its historical/cultural significance, but don&rsquo;t waste much time on the technical details of the examples.</p><h2 id=input-restrictions>Input restrictions</h2><p>The following articles deal with restrictions on the shellcode structure, such as forbidden characters or statistical properties of the input string. The examples presented will most likely not work as-they-are in a modern environment, so don&rsquo;t focus on the technical details, but rather on the methodology presented.</p><p><a href=http://phrack.org/issues/57/15.html><em>Writing ia32 alphanumeric shellcodes</em>, 2001 - rix</a> - probably the first comprehensive presentation of how to automatically convert generic shellcodes to alphanumeric ones.</p><p><a href=http://phrack.org/issues/61/11.html><em>Building IA32 &lsquo;Unicode-Proof&rsquo; Shellcodes</em>, 2003 - obscou</a> - rather than being concerned with input <em>restrictions</em>, this addresses ulterior transformations on input, namely converting an ASCII string to a UTF-16 one (as mentioned in the article&rsquo;s introduction, you could also imagine other possible transformations, such as case normalization).</p><p><a href=http://phrack.org/issues/62/9.html><em>Writing UTF-8 compatible shellcodes</em>, 2004 - Wana</a></p><p><a href=https://www.cs.jhu.edu/~sam/ccs243-mason.pdf><em>English shellcode</em>, 2009 - Mason, Small, Monrose, MacManus</a> - delves into automatically generating shellcode which has the same statistical properties as English text.</p><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/security-summer-school/security-summer-school.github.io/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/security-summer-school/security-summer-school.github.io/issues/new>tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector(".feedback--answer-yes"),noButton=document.querySelector(".feedback--answer-no"),yesResponse=document.querySelector(".feedback--response-yes"),noResponse=document.querySelector(".feedback--response-no"),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=e=>{if(typeof ga!="function")return;const t={command:"send",hitType:"event",category:"Helpful",action:"click",label:window.location.pathname,value:e};ga(t.command,t.hitType,t.category,t.action,t.label,t.value)};yesButton.addEventListener("click",()=>{yesResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(1)}),noButton.addEventListener("click",()=>{noResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script><br></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel=noopener href=https://bit.ly/DiscordSecuritySummerSchool aria-label=Discord><i class="fab fa-discord"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Facebook aria-label=Facebook><a class=text-white target=_blank rel=noopener href=https://www.facebook.com/SSSUPB/ aria-label=Facebook><i class="fab fa-facebook"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank rel=noopener href=https://bit.ly/YoutubeSecuritySummerSchool aria-label=Youtube><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/security-summer-school aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 Open-Source Contributors. All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.aa9f4c5dae6a98b2c46277f4c56f1673a2b000d1756ce4ffae93784cab25e6d5.js integrity="sha256-qp9MXa5qmLLEYnf0xW8Wc6KwANF1bOT/rpN4TKsl5tU=" crossorigin=anonymous></script></body></html>