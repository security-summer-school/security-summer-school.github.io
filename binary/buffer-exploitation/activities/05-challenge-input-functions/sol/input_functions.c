#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <time.h>


int step1(void)
{
    unsigned long num = random();
    num ^= num & 0x0a0a0a0a0a0a0a0a;
    unsigned long pad[10];
    unsigned long check = 0;

    printf("Insert the number: ((%lu))\n", num);
    fflush(stdout);

    fgets(&check, 16, stdin);
    fflush(stdin);

    return -(check != num);
}

int step2(void)
{
    unsigned long num = random();
    unsigned long pad[10];
    unsigned long check = 0;

    printf("Insert the number: [[%lu]]\n", num);
    fflush(stdout);

    fread(&check, 1, 32, stdin);
    fflush(stdin);

    return -(check != num);
}

int step3(void)
{
    unsigned long num1 = random();
    unsigned long num2 = random();
    unsigned long check1 = 0;
    unsigned long pad[10];
    unsigned long check2 = 0;

    printf("Insert the number: {{%lu}} {{%lu}}\n", num1, num2);
    fflush(stdout);

    scanf("%lu", &check1);
    fflush(stdin);

    read(0, &check2, 64);
    /*fflush(stdin);*/

    return -(check1 != num1 || check2 != num2);
}

int main(void)
{
    srandom(time(NULL));
    /*setvbuf(stdin, NULL, _IONBF, 0);*/
    setvbuf(stdout, NULL, _IONBF, 0);

    printf("===========================================================================\n");
    printf("Input Lock\n");
    printf("===========================================================================\n");
    printf("To get access to the shell insert the required numbers:\n");

    int status = 0;
    for (int i = 0; i < 10; i ++) {
        status = step1();
        if (status < 0)
            exit(-1);
    }

    for (int i = 0; i < 10; i ++) {
        status = step2();
        if (status < 0)
            exit(-1);
    }

    for (int i = 0; i < 10; i ++) {
        status = step3();
        if (status < 0)
            exit(-1);
    }

    system("/bin/sh");

    return 0;
}
