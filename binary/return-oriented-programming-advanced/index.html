<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Security Summer School</title><meta name=description content="Return Oriented Programming Advanced Table of Contents Return Oriented Programming Advanced Calling Conventions in the ROP Context ROP gadgets on x86_64 Libc leaks Challenges 01. Challenge - Using ROP to Leak and Call system 02. Challenge - Handling Low Stack Space 03. Challenge - Stack Pivoting 04. Challenge - mprotect Further Reading In this lab we are going to dive deeper into Return Oriented Programming and setbacks that appear in modern exploitation."><meta property="og:title" content><meta property="og:description" content="Return Oriented Programming Advanced Table of Contents Return Oriented Programming Advanced Calling Conventions in the ROP Context ROP gadgets on x86_64 Libc leaks Challenges 01. Challenge - Using ROP to Leak and Call system 02. Challenge - Handling Low Stack Space 03. Challenge - Stack Pivoting 04. Challenge - mprotect Further Reading In this lab we are going to dive deeper into Return Oriented Programming and setbacks that appear in modern exploitation."><meta property="og:type" content="article"><meta property="og:url" content="/binary/return-oriented-programming-advanced/"><meta property="article:section" content="binary"><meta property="og:site_name" content="Security Summer School"><meta itemprop=name content><meta itemprop=description content="Return Oriented Programming Advanced Table of Contents Return Oriented Programming Advanced Calling Conventions in the ROP Context ROP gadgets on x86_64 Libc leaks Challenges 01. Challenge - Using ROP to Leak and Call system 02. Challenge - Handling Low Stack Space 03. Challenge - Stack Pivoting 04. Challenge - mprotect Further Reading In this lab we are going to dive deeper into Return Oriented Programming and setbacks that appear in modern exploitation."><meta itemprop=wordCount content="1622"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Return Oriented Programming Advanced Table of Contents Return Oriented Programming Advanced Calling Conventions in the ROP Context ROP gadgets on x86_64 Libc leaks Challenges 01. Challenge - Using ROP to Leak and Call system 02. Challenge - Handling Low Stack Space 03. Challenge - Stack Pivoting 04. Challenge - mprotect Further Reading In this lab we are going to dive deeper into Return Oriented Programming and setbacks that appear in modern exploitation."><link rel=preload href=/scss/main.min.5aef8a3f4159801f5dbe642e33f5332212e837eda91d37dcd891fdcd5c32498a.css as=style><link href=/scss/main.min.5aef8a3f4159801f5dbe642e33f5332212e837eda91d37dcd891fdcd5c32498a.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=font-weight-bold>Security Summer School</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/binary/><span class=active>Binary Exploitation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/essentials/><span>Security Essentials</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/><span>Web Security</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-binary-li><a href=/binary/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-binary><span>Binary Exploitation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybuffer-exploitation-li><a href=/binary/buffer-exploitation/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybuffer-exploitation><span>Buffer Exploitation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarydefense-mechanisms-li><a href=/binary/defense-mechanisms/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarydefense-mechanisms><span>Defense Mechanisms</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarydynamic-analysis-li><a href=/binary/dynamic-analysis/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarydynamic-analysis><span>Dynamic Analysis</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryexecutables-and-processes-li><a href=/binary/executables-and-processes/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryexecutables-and-processes><span>Executables and Processes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryexploration-tools-li><a href=/binary/exploration-tools/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryexploration-tools><span>Exploration Tools</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryinformation-leaks-li><a href=/binary/information-leaks/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryinformation-leaks><span>Information Leaks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryreturn-oriented-programming-li><a href=/binary/return-oriented-programming/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryreturn-oriented-programming><span>Return Oriented Programming</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-binaryreturn-oriented-programming-advanced-li><a href=/binary/return-oriented-programming-advanced/ title class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-binaryreturn-oriented-programming-advanced><span class=td-sidebar-nav-active-item>Return Oriented Programming Advanced</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryshellcodes-li><a href=/binary/shellcodes/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryshellcodes><span>Shellcodes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryshellcodes-advanced-li><a href=/binary/shellcodes-advanced/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryshellcodes-advanced><span>Shellcodes Advanced</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarystatic-analysis-li><a href=/binary/static-analysis/ title class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarystatic-analysis><span>Static Analysis</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities03-tutorial-bypass-dep-no-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/03-tutorial-bypass-dep-no-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities03-tutorial-bypass-dep-no-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities08-challenge-bypass-dep-no-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/08-challenge-bypass-dep-no-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities08-challenge-bypass-dep-no-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binarybypassing-mitigationsactivities09-challenge-bypass-dep-aslr-libcreadme-li><a href=/binary/bypassing-mitigations/activities/09-challenge-bypass-dep-aslr-libc/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binarybypassing-mitigationsactivities09-challenge-bypass-dep-aslr-libcreadme><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-binaryextrapwntools-introreadme-li><a href=/binary/extra/pwntools-intro/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-binaryextrapwntools-introreadme><span></span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/security-summer-school/security-summer-school.github.io/tree/main/content/en/binary/return-oriented-programming-advanced/index.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> View page source</a>
<a href=https://github.com/security-summer-school/security-summer-school.github.io/edit/main/content/en/binary/return-oriented-programming-advanced/index.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/security-summer-school/security-summer-school.github.io/new/main/content/en/binary/return-oriented-programming-advanced/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/security-summer-school/security-summer-school.github.io/issues/new?title=" class=td-page-meta--issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/security-summer-school/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
<a id=print href=/binary/_print/><i class="fa fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#table-of-contents>Table of Contents</a></li><li><a href=#calling-conventions-in-the-rop-context>Calling Conventions in the ROP Context</a></li><li><a href=#rop-gadgets-on-x86_64>ROP gadgets on x86_64</a></li><li><a href=#libc-leaks>Libc leaks</a></li><li><a href=#challenges>Challenges</a><ul><li><a href=#01-challenge---using-rop-to-leak-and-call-system>01. Challenge - Using ROP to Leak and Call system</a></li><li><a href=#02-challenge---handling-low-stack-space>02. Challenge - Handling Low Stack Space</a></li><li><a href=#03-challenge---stack-pivoting>03. Challenge - Stack Pivoting</a></li><li><a href=#04-challenge---mprotect>04. Challenge - mprotect</a></li></ul></li><li><a href=#further-reading>Further Reading</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/binary/>Binary Exploitation</a></li><li class="breadcrumb-item active" aria-current=page><a href=/binary/return-oriented-programming-advanced/ aria-disabled=true class="btn-link disabled">Return Oriented Programming Advanced</a></li></ol></nav><div class=td-content><h1></h1><header class=article-meta></header><h1 id=return-oriented-programming-advanced>Return Oriented Programming Advanced</h1><h2 id=table-of-contents>Table of Contents</h2><ul><li><a href=#return-oriented-programming-advanced>Return Oriented Programming Advanced</a><ul><li><a href=#calling-conventions-in-the-rop-context>Calling Conventions in the ROP Context</a></li><li><a href=#rop-gadgets-on-x86_64>ROP gadgets on x86_64</a></li><li><a href=#libc-leaks>Libc leaks</a></li><li><a href=#challenges>Challenges</a><ul><li><a href=#01-challenge---using-rop-to-leak-and-call-system>01. Challenge - Using ROP to Leak and Call system</a></li><li><a href=#02-challenge---handling-low-stack-space>02. Challenge - Handling Low Stack Space</a></li><li><a href=#03-challenge---stack-pivoting>03. Challenge - Stack Pivoting</a></li><li><a href=#04-challenge---mprotect>04. Challenge - mprotect</a></li></ul></li><li><a href=#further-reading>Further Reading</a></li></ul></li></ul><p>In this lab we are going to dive deeper into <em>Return Oriented Programming</em> and setbacks that appear in modern exploitation. Topics covered:</p><ul><li>ROP for syscalls and 64 bits</li><li>Dealing with ASLR in ROP</li><li>Dealing with low space in the overflown buffer</li><li>Combining ROP and shellcodes</li></ul><p>As the basis of the lab we will use a program based on a classical CTF challenge called <em>ropasaurusrex</em> and gradually make exploitation harder.</p><h2 id=calling-conventions-in-the-rop-context>Calling Conventions in the ROP Context</h2><p>As you know, the calling convention for 32 bits uses the stack. This means that setting up parameters is as easy as just writing them in the payload.</p><p>We can see how a function call is generated in this <a href=https://gcc.godbolt.org/z/MPG5MhEnE>Compiler Explorer example</a>.</p><p>Syscalls are special, the arguments are passed using the registers and <code>int 0x80</code> or the equivalent <code>call DWORD PTR gs:0x10</code> is used such that more work is needed: <code>pop ?; ret</code> gadgets are needed to load the registers with the desired values.</p><p>In the assembly below you see a disassembly of the calling of a system call <code>read(0, 0x8048000, 0x100)</code>, with the system call in the <code>eax</code> register and the system call arguments in the other registers:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#000>mov</span> <span style=color:#000>eax</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0x3</span>
</span></span><span style=display:flex><span><span style=color:#000>mov</span> <span style=color:#000>ebx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#000>mov</span> <span style=color:#000>ecx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0x08048000</span>
</span></span><span style=display:flex><span><span style=color:#000>mov</span> <span style=color:#000>edx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0x100</span>
</span></span><span style=display:flex><span><span style=color:#000>int</span> <span style=color:#0000cf;font-weight:700>0x80</span>
</span></span></code></pre></div><p>The calling convention for 64 bit processors (<code>x86_64</code>) is different and mainly uses registers instead of the stack, see this <a href=https://gcc.godbolt.org/z/1Ys6M3Pdc>Compiler Explorer example</a>.</p><p>Syscalls on 64 bits are conceptually the same as on 32 bits, but it uses different registers, different syscall codes and the <code>syscall</code> mnemonic is used for making a system call:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#000>mov</span> <span style=color:#000>rax</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#000>mov</span> <span style=color:#000>rdi</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#000>mov</span> <span style=color:#000>rsi</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0x08048000</span>
</span></span><span style=display:flex><span><span style=color:#000>mov</span> <span style=color:#000>rdx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0x100</span>
</span></span><span style=display:flex><span><span style=color:#000>syscall</span>
</span></span></code></pre></div><h2 id=rop-gadgets-on-x86_64>ROP gadgets on x86_64</h2><p>On <code>x86_64</code> the ROP payloads will have to be built differently than on <code>x86</code> because of the different calling convention. Having the function arguments stored in registers means that you don&rsquo;t need to do stack cleanup anymore, but you will need gadgets with <strong>specific registers</strong> to pop the arguments into.</p><p>For example to do the <code>read(0, buf, size)</code> <em>libc call</em> to do this call your payload will need to look like:</p><pre tabindex=0><code>pop rdi; ret
0
pop rsi, ret
buf_addr
pop rdx; ret
size
call read@plt
</code></pre><h2 id=libc-leaks>Libc leaks</h2><p>You might have already encountered in other tasks the need to leak values or addresses. Most of the time, if you want to get a shell, you won&rsquo;t have a convenient <code>system@plt</code> symbol present in your binary, and ASLR will most often be activated; so you will have to compute it relative to another libc symbol at runtime.</p><p>For this we will need to know what libc library the program is loading. For a local executable we can just run <code>ldd</code>:</p><pre tabindex=0><code>$ ldd rop
    linux-vdso.so.1 (0x00007ffd0834b000)
    libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007fec18eb6000)
    /lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007fec190aa000)
</code></pre><p>For remote tasks you can might get an attached <code>libc.so</code>, or you can use the <a href=https://libc.blukat.me/>Libc database</a> to find the correct libc based on some leaked offsets.</p><p>How to compute and use the <code>system</code> function address using pwntools:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>pwn</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#ce5c00;font-weight:700>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>libc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ELF</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/usr/lib/libc.so.6&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic># from `ldd rop`</span>
</span></span><span style=display:flex><span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>process</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;rop&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># read the leaked address of the write@got function from the program</span>
</span></span><span style=display:flex><span><span style=color:#000>write_leak</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>u64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>recv</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># compute the starting address of the libc library</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># setting libc.address to this value will offset all future symbol accesses</span>
</span></span><span style=display:flex><span><span style=color:#000>libc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>write_leak</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>libc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>symbols</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;write&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># use the address of system in the payload</span>
</span></span><span style=display:flex><span><span style=color:#000>payload</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>p64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>libc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>symbols</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;system&#39;</span><span style=color:#000;font-weight:700>])</span>
</span></span></code></pre></div><h2 id=challenges>Challenges</h2><p><strong>NOTE</strong>: All tasks from this session are 64 bit binaries, so take that into consideration when you build the ROP chains.</p><h3 id=01-challenge---using-rop-to-leak-and-call-system>01. Challenge - Using ROP to Leak and Call system</h3><p>Use the <code>01-leak-call-system/src</code> executable file in order to spawn a shell.</p><p>You can now call the functions in the binary but <code>system</code> or any other appropriate function is missing and ASLR is enabled. How do you get past this? You need an information leak! To leak information we want to print it to standard output and process it.
We use calls to <code>printf</code>, <code>puts</code> or <code>write</code> for this. In our case we can use the <code>write</code> function call.</p><blockquote><p>If you have a string representation of a number you can unpack it using the <code>unpack</code>/<code>u64</code> function in pwntools. It is the reverse of the <code>pack</code>/<code>p64</code> function.</p></blockquote><p>First, trigger the information leak by calling the <code>write</code> function and leaking an address from libc.</p><blockquote><p>You can use the GOT table storing libc addresses.</p></blockquote><p>You need to read the output from the above <code>write</code> call. Use <code>p.recv(8)</code> in the Python script to read the 8 bytes output of the <code>write</code> call in the ROP chain.</p><blockquote><p>Remember that you need gadgets to pop values into rdi, rsi, rdx for the <code>write</code> call.</p></blockquote><p>Find the address of the <code>system</code> call.</p><blockquote><p>Remember the libc leaks section above</p></blockquote><p>Call <code>system</code>.</p><blockquote><p>You can&rsquo;t write the <code>system</code> address in the ROP chain as it is different each time and the ROP chain is statically defined. You can use the GOT table again. Write an entry in the GOT table with the newly found address and call the function for that entry. It will evolve into a call to <code>system</code>.</p><p>To write an entry in the GOT table use the <code>read</code> call in the ROP chain. You will feed to <code>read</code> the computed address below.</p><p>For the actual parameter use the <code>"sh"</code> string already present in the vulnerable binary. Use searchmem in GDB to find the <code>"sh"</code> string in the executable.</p></blockquote><h3 id=02-challenge---handling-low-stack-space>02. Challenge - Handling Low Stack Space</h3><p>The previous binary had the luxury of plenty of stack space to be overflown. It is often the case that we don&rsquo;t have enough space for a long ROP chain. Let&rsquo;s handle that.</p><p>For the current task, switch to the <code>02-low-stack-space/src</code> sub-folder. The extra constraint here is that huge ropchains are no longer an option.</p><p>Find out how much space you have in the overflow and assess the situation.</p><blockquote><p>Use <code>gdb</code> and the cyclic pattern to get the information required.</p></blockquote><p>Now follow the steps below.</p><p>First trigger the info leak as before.</p><blockquote><p>Use <code>write</code> and leak the address of a GOT value. Use this to compute the address of the <code>system</code> call.</p></blockquote><p>You can only construct a partial ropchain. A longer one won&rsquo;t fit. So after calling <code>write</code>, call <code>main</code> again.</p><blockquote><p>Note that using <code>sendline</code> means sending out a newline character (<code>'\n'</code>) at the end of the message. If you want to strictly send out a message without a newline, use <code>send</code>.</p><p>Find the address of <code>main</code> by looking at the argument for the <code>__libc_start_main</code> function. Check the disassembling of the program and see what is the parameter passed to the <code>__libc_start_main call</code>.</p><p>After calling <code>main</code> again you will get back to the initial situation where you can exploit the buffer overflow.</p></blockquote><p>Insert <code>"sh"</code> string.</p><blockquote><p>This time you don&rsquo;t have the <code>"sh"</code> string in the binary, but you can find it in <strong>the libc binary itself</strong> so you can compute it the same way you compute the <code>system</code> address. In pwntools:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>sh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>next</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>libc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>search</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>b</span><span style=color:#4e9a06>&#34;/bin/sh</span><span style=color:#4e9a06>\x00</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>))</span>
</span></span></code></pre></div></blockquote><p>Call <code>system</code>.</p><h3 id=03-challenge---stack-pivoting>03. Challenge - Stack Pivoting</h3><p>Let&rsquo;s assume that <code>main</code> function had additional constraints that made it impossible to repeat the overflow. How can we still solve it? The method is called stack pivoting. In short, this means making the stack pointer refer another (writable) memory area that has enough space, a memory area that we will populate with the actual ROP chain.</p><blockquote><p>Read more about stack pivoting <a href=http://neilscomputerblog.blogspot.ro/2012/06/stack-pivoting.html>here</a>.</p></blockquote><p>Tour goal is to fill the actual ROP chain to a large enough memory area. We need a two stage exploit:</p><ul><li>In the first stage, prepare the memory area where to fill the second stage ROP chain; then fill the memory area with the second stage ROP chain.</li><li>In the second stage, create the actual ROP chain and feed it to the program and profit.</li></ul><p>Follow the steps below.</p><p>Use pmap or vmmap in <code>pwndbg</code> to discover the writable data section of the process. Select an address in that section (<strong>don&rsquo;t</strong> use the start address). This is where you fill the 2nd stage data (the actual ROP chain).</p><blockquote><p>Who not use the start address? Because <code>pop</code> instructions (which decrease the <code>rsp</code>) will go outside the memory region.</p></blockquote><p>Create a first stage payload that calls <code>read</code> to store the 2nd stage data to the newly found memory area. After that pivot the stack pointer to the memory area address.</p><blockquote><p>At a given address in the executable you have a call to <code>read</code> followed by a <code>leave; ret</code> gadget. This sequence of instructions allows you to read data and then pivot the stack.</p><p>The leave instruction fills the stack pointer (<code>rsp</code>) with the address of the frame pointer (<code>rbp</code>). It&rsquo;s equivalent to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#000>mov</span> <span style=color:#000>rsp</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>rbp</span>
</span></span><span style=display:flex><span><span style=color:#000>pop</span> <span style=color:#000>rbp</span>
</span></span></code></pre></div></blockquote><p>Write the actual ROP chain as a second stage payload like when we didn&rsquo;t have space constraints. The 2nd stage will be stored to the memory area and the stack pointer will point to that.</p><blockquote><p><strong>Important!</strong> Be careful when and where the stack pivoting takes place. After the <code>mov rsp, rbp</code> part of the <code>leave</code> instruction happens your stack will be pivoted, so the following <code>pop rbp</code> will happen <strong>on the new stack</strong>. Take this offset into account when building the payload.</p></blockquote><h3 id=04-challenge---mprotect>04. Challenge - mprotect</h3><p>Combine everything you&rsquo;ve learned until now and develop a complex payload to call <code>mprotect</code> to change the permissions on a memory region to read+write+execute and then instert a <em>shellcode</em> to call <code>system("/bin/sh")</code>.</p><h2 id=further-reading>Further Reading</h2><ul><li><a href=https://syscalls.kernelgrok.com/>https://syscalls.kernelgrok.com/</a></li><li><a href=http://articles.manugarg.com/systemcallinlinux2_6.html>http://articles.manugarg.com/systemcallinlinux2_6.html</a></li><li><a href=https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries#the-procedure-linkage-table-plt>https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries#the-procedure-linkage-table-plt</a></li><li><a href=https://github.com/Gallopsled/pwntools-tutorial/tree/master/walkthrough>https://github.com/Gallopsled/pwntools-tutorial/tree/master/walkthrough</a></li></ul><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/security-summer-school/security-summer-school.github.io/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/security-summer-school/security-summer-school.github.io/issues/new>tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector(".feedback--answer-yes"),noButton=document.querySelector(".feedback--answer-no"),yesResponse=document.querySelector(".feedback--response-yes"),noResponse=document.querySelector(".feedback--response-no"),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=e=>{if(typeof ga!="function")return;const t={command:"send",hitType:"event",category:"Helpful",action:"click",label:window.location.pathname,value:e};ga(t.command,t.hitType,t.category,t.action,t.label,t.value)};yesButton.addEventListener("click",()=>{yesResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(1)}),noButton.addEventListener("click",()=>{noResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script><br></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel=noopener href=https://bit.ly/DiscordSecuritySummerSchool aria-label=Discord><i class="fab fa-discord"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Facebook aria-label=Facebook><a class=text-white target=_blank rel=noopener href=https://www.facebook.com/SSSUPB/ aria-label=Facebook><i class="fab fa-facebook"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank rel=noopener href=https://bit.ly/YoutubeSecuritySummerSchool aria-label=Youtube><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/security-summer-school aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 Open-Source Contributors. All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.aa9f4c5dae6a98b2c46277f4c56f1673a2b000d1756ce4ffae93784cab25e6d5.js integrity="sha256-qp9MXa5qmLLEYnf0xW8Wc6KwANF1bOT/rpN4TKsl5tU=" crossorigin=anonymous></script></body></html>